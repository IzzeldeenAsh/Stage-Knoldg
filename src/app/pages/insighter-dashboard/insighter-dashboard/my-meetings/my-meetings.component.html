<!-- Page Header with Tabs -->
<app-page-header
  [titleEn]="'Meetings'"
  [titleAr]="'الاجتماعات'"
  [lang]="lang"
  [subtitle]="getMeetingsSubtitle()"
  [showTabs]="!(isClient$ | async)">


  <i slot="icon" class="ki-duotone ki-calendar-2  fs-2x text-info">
 <span class="path1"></span>
 <span class="path2"></span>
 <span class="path3"></span>
 <span class="path4"></span>
 <span class="path5"></span>
</i>

  <!-- Tabs slot -->
  <ng-container slot="tabs" *ngIf="!(isClient$ | async)">
    <li class="nav-item">
      <a class="nav-link text-active-primary pb-4"
        [class.active]="activeTab === 'client-meetings'"
        (click)="setActiveTab('client-meetings')">
        {{ lang === 'ar' ? 'اجتماعات العملاء' : 'Client Meetings' }}
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link text-active-primary pb-4"
        [class.active]="activeTab === 'my-meetings'"
        (click)="setActiveTab('my-meetings')">
        {{ lang === 'ar' ? 'اجتماعاتي' : 'My Meetings' }}
      </a>
    </li>
  </ng-container>
</app-page-header>

<div class="py-1 bg-white rounded-2">
  <div class="tab-content">

  <!-- Client Meetings Tab -->
  <ng-container *ngIf="activeTab === 'client-meetings' && !(isClient$ | async)" >
    <!-- Nested Tabs for Client Meetings -->
    <div class="row mb-0">
      <div class="col-12">
        <div class="nested-tab-nav">
          <button
            type="button"
            class="nested-tab-button"
            [ngClass]="{ 'active': clientMeetingsSubTab === 'coming' }"
            (click)="setClientMeetingsSubTab('coming')">
            {{ lang === 'ar' ? 'القادمة' : 'Coming' }}
          </button>
          <button
            type="button"
            class="nested-tab-button"
            [ngClass]="{ 'active': clientMeetingsSubTab === 'past' }"
            (click)="setClientMeetingsSubTab('past')">
            {{ lang === 'ar' ? 'السابقة' : 'Past' }}
          </button>
        </div>
      </div>
    </div>

    <div class="nested-tab-content">
      <!-- Archived Toggle Button for Past Meetings -->
      @if (clientMeetingsSubTab === 'past') {
        <div class="row mb-4">
          <div class="col-12">
            <div class="d-flex justify-content-start">
              <button class="btn btn-sm btn-outline-info d-flex align-items-center toggle-archived-btn"
                      [class.active]="showArchivedMeetings()"
                      (click)="toggleArchivedMeetings()"
                      [pTooltip]="showArchivedMeetings() ? 'Show Past Meetings' : 'Show Archived Meetings'"
                      tooltipPosition="top">
                @if (showArchivedMeetings()) {
                  <i class="pi pi-arrow-left me-2 text-dark" style="font-size: 1rem;"></i>
                } @else {
                  <i class="pi pi-inbox me-2 text-dark" style="font-size: 1rem;"></i>
                }
                {{ showArchivedMeetings() ? 'Past' : 'Archived' }}
                <span *ngIf="!showArchivedMeetings() && clientArchivedCount() > 0"
                      class="badge badge-light-info ms-2">
                  {{ clientArchivedCount() }}
                </span>
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Loading State -->
      @if (loading()) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      }

      <!-- Client Meetings Grid -->
      @if (!loading()) {
        <div class="row g-4">
          @if (getFilteredClientMeetings().length === 0) {
            <div class="col-12">
              <div class="text-center py-5">
                <i class="ki-duotone ki-calendar-8 fs-3x text-gray-400 mb-3">
                  <span class="path1"></span>
                  <span class="path2"></span>
                  <span class="path3"></span>
                  <span class="path4"></span>
                  <span class="path5"></span>
                  <span class="path6"></span>
                </i>
                <h4 class="text-gray-700 mb-2">{{ 'MEETINGS.NO_MEETINGS' | translate }}</h4>
                <p class="text-gray-500">{{ 'MEETINGS.NO_MEETINGS_DESC' | translate }}</p>
              </div>
            </div>
          }

          @for (meeting of getFilteredClientMeetings(); track meeting.uuid; let i = $index) {
            <div class="col-xl-4 col-lg-6 col-md-6">
              <div class="card meeting-card h-100"
                   [class.closest-meeting]="isClosestMeeting(meeting, i)">
                <div class="card-body d-flex flex-column">
                  <!-- Meeting Header -->
                  <div class="d-flex align-items-center mb-4">
                    <div class="meeting-date-badge me-3">
                      <div class="month">{{ formatMonth(meeting.date) }}</div>
                      <div class="day">{{ formatDay(meeting.date) }}</div>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="card-title mb-1"
                          [pTooltip]="meeting.title"
                          tooltipPosition="top"
                          [style.cursor]="meeting.title && meeting.title.length > 30 ? 'help' : 'default'">
                        {{ meeting.title | truncateText:30 }}
                      </h5>
                      <div class="meeting-time text-muted">
                        <i class="ki-duotone ki-time me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        {{ formatTime(meeting.start_time) }} - {{ formatTime(meeting.end_time) }}
                      </div>
                    </div>
                    <!-- Archive Button for Past Meetings -->
                    @if (clientMeetingsSubTab === 'past' && !showArchivedMeetings && meeting.status !== 'pending') {
                      <button class="btn btn-xs btn-light-warning d-flex align-items-center px-2 py-1"
                              (click)="archiveMeeting(meeting)"
                              [disabled]="actionLoading()"
                              [pTooltip]="'Archive Meeting'"
                              tooltipPosition="top"
                              aria-label="Archive Meeting">
                        <i class="pi pi-inbox" style="font-size: 1rem; padding: 0;"></i>
                      </button>
                    }
                  </div>

                  <!-- Client Meeting Status and Action Buttons -->
                  <div class="mb-3 d-flex align-items-center justify-content-between">
                    @if (meeting.status !== 'pending') {
                      <span class="badge" [ngClass]="getStatusClass(meeting.status)">
                        {{ ('MEETINGS.STATUS.' + meeting.status.toUpperCase()) | translate }}
                      </span>
                    }

                    <!-- Action Buttons for Pending Meetings -->
                    @if (meeting.status === 'pending' && clientMeetingsSubTab !== 'past') {
                      <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success d-flex align-items-center px-2 py-1"
                                (click)="openApproveModal(meeting)"
                                [pTooltip]="'Approve Meeting'"
                                tooltipPosition="top"
                                aria-label="Approve Meeting">
                          <i class="ki-duotone ki-check fs-4">
                            <span class="path1"></span>
                            <span class="path2"></span>
                          </i>
                        </button>
                        <button class="btn btn-sm btn-warning d-flex align-items-center px-2 py-1"
                                (click)="openPostponeModal(meeting)"
                                [pTooltip]="'Postpone Meeting'"
                                tooltipPosition="top"
                                aria-label="Postpone Meeting">
                          <i class="ki-duotone ki-time fs-4">
                            <span class="path1"></span>
                            <span class="path2"></span>
                          </i>
                        </button>
                      </div>
                    }
                  </div>

                  <!-- Meeting Description -->
                  <div class="meeting-description mb-4 flex-grow-1">
                    <p class="text-gray-600 mb-0" 
                       [pTooltip]="meeting.description ? meeting.description : 'No description available'" 
                       tooltipPosition="top"
                       [style.cursor]="meeting.description && meeting.description.length > 100 ? 'help' : 'default'">
                     {{ ( (meeting.description == "No description provided" || meeting.description == "No description available") ? ('INSIGHTER.MEETINGS.NO_DESCRIPTION' | translate) : meeting.description || ('INSIGHTER.MEETINGS.NO_DESCRIPTION' | translate) ) | truncateText:100:true }}
                    </p>
                  </div>

                  <!-- Client Info -->
                  <div class="meeting-participant">
                    <div class="d-flex align-items-center">
                      <div class="symbol symbol-40px me-3">
                        <a (click)="goToClientProfile(meeting)" tabindex="0" (keydown.enter)="goToClientProfile(meeting)">
                          @if (meeting.client.profile_photo_url) {
                            <img [src]="meeting.client.profile_photo_url"
                                 [alt]="meeting.client.name"
                                 class="rounded-circle"
                                 style="object-position: top;">
                          } @else {
                            <div class="symbol-label bg-primary text-white">
                              {{ getInitials(meeting.client.first_name, meeting.client.last_name) }}
                            </div>
                          }
                        </a>
                      </div>
                      <div class="flex-grow-1">
                        <a (click)="goToClientProfile(meeting)" tabindex="0" (keydown.enter)="goToClientProfile(meeting)">
                          <div class="fw-bold text-gray-800"
                               [pTooltip]="meeting.client.name"
                               tooltipPosition="top"
                               [style.cursor]="meeting.client.name && meeting.client.name.length > 25 ? 'help' : 'default'">
                            {{ meeting.client.name | truncateText:25:true }}
                          </div>
                          <div class="text-muted fs-7"
                               [pTooltip]="meeting.client.email"
                               tooltipPosition="top"
                               [style.cursor]="meeting.client.email && meeting.client.email.length > 25 ? 'help' : 'default'">
                            {{ meeting.client.email | truncateText:25 }}
                          </div>
                        </a>
                      </div>
                      <!-- Join Button for Approved Meetings with valid URL -->
                      @if (meeting.status === 'approved' && meeting.meeting_url && meeting.meeting_url !== '?pwd=') {
                        <div class="ms-2">
                          <button type="button"
                                  class="btn btn-sm btn-secondary"
                                  (click)="joinMeeting(meeting.meeting_url)"
                                  [pTooltip]="'MEETINGS.JOIN_MEETING' | translate"
                                  tooltipPosition="top">
                            <i class="ki-duotone ki-entrance-right me-1">
                              <span class="path1"></span>
                              <span class="path2"></span>
                            </i>
                            {{ 'MEETINGS.JOIN' | translate }}
                          </button>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Client Meetings Pagination -->
          @if (!loading() && (showArchivedMeetings() ? archivedTotalPages() : totalPages()) > 1) {
            <div class="row mt-5">
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="pagination-info text-muted">
                    {{ 'MEETINGS.SHOWING' | translate }}
                    {{ ((showArchivedMeetings() ? archivedCurrentPage() : currentPage()) - 1) * perPage() + 1 }}
                    {{ 'MEETINGS.TO' | translate }}
                    {{ Math.min((showArchivedMeetings() ? archivedCurrentPage() : currentPage()) * perPage(), showArchivedMeetings() ? archivedTotalItems() : totalItems()) }}
                    {{ 'MEETINGS.OF' | translate }}
                    {{ showArchivedMeetings() ? archivedTotalItems() : totalItems() }}
                    {{ 'MEETINGS.RESULTS' | translate }}
                  </div>

                  <nav aria-label="Pagination">
                    <ul class="pagination pagination-outline">
                      <li class="page-item" [class.disabled]="getClientCurrentPage() === 1">
                        @if (getClientCurrentPage() > 1) {
                          <a class="page-link"
                             (click)="onClientMeetingsPageChange(getClientCurrentPage() - 1)"
                             tabindex="0"
                             aria-label="Previous page"
                             (keydown.enter)="onClientMeetingsPageChange(getClientCurrentPage() - 1)">
                            <i class="ki-duotone ki-black-left">
                              <span class="path1"></span>
                              <span class="path2"></span>
                            </i>
                          </a>
                        }
                      </li>

                      @for (page of getClientPageNumbers(); track page) {
                        <li class="page-item" [class.active]="getClientCurrentPage() === page">
                          <a class="page-link"
                             (click)="onClientMeetingsPageChange(page)"
                             tabindex="0"
                             (keydown.enter)="onClientMeetingsPageChange(page)">
                            {{ page }}
                          </a>
                        </li>
                      }

                      <li class="page-item" [class.disabled]="getClientCurrentPage() === getClientTotalPages()">
                        @if (getClientCurrentPage() < getClientTotalPages()) {
                          <a class="page-link"
                             (click)="onClientMeetingsPageChange(getClientCurrentPage() + 1)"
                             tabindex="0"
                             aria-label="Next page"
                             (keydown.enter)="onClientMeetingsPageChange(getClientCurrentPage() + 1)">
                            <i class="ki-duotone ki-black-right">
                              <span class="path1"></span>
                              <span class="path2"></span>
                            </i>
                          </a>
                        }
                      </li>
                    </ul>
                  </nav>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </ng-container>

  <!-- My Meetings Tab -->
  <ng-container *ngIf="activeTab === 'my-meetings'">
    <!-- Nested Tabs for Sent Meetings -->
    <div class="row mb-0">
      <div class="col-12">
        <div class="nested-tab-nav">
          <button
            type="button"
            class="nested-tab-button"
            [ngClass]="{ 'active': myMeetingsSubTab === 'coming' }"
            (click)="setMyMeetingsSubTab('coming')">
            {{ lang === 'ar' ? 'القادمة' : 'Coming' }}
          </button>
          <button
            type="button"
            class="nested-tab-button"
            [ngClass]="{ 'active': myMeetingsSubTab === 'past' }"
            (click)="setMyMeetingsSubTab('past')">
            {{ lang === 'ar' ? 'السابقة' : 'Past' }}
          </button>
        </div>
      </div>
    </div>

    <div class="nested-tab-content">
      <!-- Archived Toggle Button for Past Meetings -->
      @if (myMeetingsSubTab === 'past') {
        <div class="row mb-4">
          <div class="col-12">
            <div class="d-flex justify-content-start">
              <button class="btn btn-sm btn-outline-info d-flex align-items-center toggle-archived-btn"
                      [class.active]="sentShowArchivedMeetings()"
                      (click)="toggleSentArchivedMeetings()"
                      [pTooltip]="sentShowArchivedMeetings() ? 'Show Past Meetings' : 'Show Archived Meetings'"
                      tooltipPosition="top">
                @if (sentShowArchivedMeetings()) {
                  <i class="pi pi-arrow-left me-2 text-dark" style="font-size: 1rem;"></i>
                } @else {
                  <i class="pi pi-inbox me-2 text-dark" style="font-size: 1rem;"></i>
                }
                {{ sentShowArchivedMeetings() ? 'Past' : 'Archived' }}
                <span *ngIf="!sentShowArchivedMeetings() && sentArchivedCount() > 0"
                      class="badge badge-light-info ms-2">
                  {{ sentArchivedCount() }}
                </span>
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Loading State -->
      @if (sentLoading()) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      }

      <!-- Sent Meetings Grid -->
      @if (!sentLoading()) {
        <div class="row g-4">
          @if (getFilteredSentMeetings().length === 0) {
            <div class="col-12">
              <div class="text-center py-5">
                <i class="ki-duotone ki-calendar-8 fs-3x text-gray-400 mb-3">
                  <span class="path1"></span>
                  <span class="path2"></span>
                  <span class="path3"></span>
                  <span class="path4"></span>
                  <span class="path5"></span>
                  <span class="path6"></span>
                </i>
                <h4 class="text-gray-700 mb-2">{{ 'MEETINGS.NO_MEETINGS' | translate }}</h4>
                <p class="text-gray-500">{{ 'MEETINGS.NO_MEETINGS_DESC' | translate }}</p>
              </div>
            </div>
          }

          @for (meeting of getFilteredSentMeetings(); track meeting.uuid; let i = $index) {
            <div class="col-xl-4 col-lg-6 col-md-6">
              <div class="card meeting-card h-100"
                   [class.closest-meeting]="isClosestMeeting(meeting, i)">
                <div class="card-body d-flex flex-column">
                  <!-- Meeting Header -->
                  <div class="d-flex align-items-center mb-4">
                    <div class="meeting-date-badge me-3">
                      <div class="month">{{ formatMonth(meeting.date) }}</div>
                      <div class="day">{{ formatDay(meeting.date) }}</div>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="card-title mb-1"
                          [pTooltip]="meeting.title"
                          tooltipPosition="top"
                          [style.cursor]="meeting.title && meeting.title.length > 30 ? 'help' : 'default'">
                        {{ meeting.title | truncateText:30 }}
                      </h5>
                      <div class="meeting-time text-muted">
                        <i class="ki-duotone ki-time me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        {{ formatTime(meeting.start_time) }} - {{ formatTime(meeting.end_time) }}
                      </div>
                    </div>
                    <!-- Archive Button for Past Meetings -->
                    @if (myMeetingsSubTab === 'past' && !sentShowArchivedMeetings() && meeting.status !== 'pending') {
                      <button class="btn btn-xs btn-light-warning d-flex align-items-center px-2 py-1"
                              (click)="archiveSentMeeting(meeting)"
                              [disabled]="actionLoading()"
                              [pTooltip]="'Archive Meeting'"
                              tooltipPosition="top"
                              aria-label="Archive Meeting">
                        <i class="pi pi-inbox" style="font-size: 1rem; padding: 0;"></i>
                      </button>
                    }
                  </div>

                  <!-- Sent Meeting Status and Action Buttons -->
                  <div class="mb-3 d-flex align-items-center">
                    <span class="badge" [ngClass]="getStatusClass(meeting.status)">
                      {{ ('INSIGHTER.MEETINGS.STATUS.' + meeting.status.toUpperCase()) | translate }}
                    </span>
                    @if (meeting.rate !== '0') {
                      <span class="ms-2 badge badge-light-info">
                        {{ 'INSIGHTER.MEETINGS.RATE' | translate }}: {{ meeting.rate | currency }}
                      </span>
                    }
                  </div>

                  <!-- Meeting Description -->
                  <div class="meeting-description mb-4 flex-grow-1">
                    <p class="text-gray-600 mb-0"
                       [pTooltip]="meeting.description ? meeting.description : 'No description available'"
                       tooltipPosition="top"
                       [style.cursor]="meeting.description && meeting.description.length > 100 ? 'help' : 'default'">
                     {{ ( (meeting.description == "No description provided" || meeting.description == "No description available") ? ('INSIGHTER.MEETINGS.NO_DESCRIPTION' | translate) : meeting.description || ('INSIGHTER.MEETINGS.NO_DESCRIPTION' | translate) ) | truncateText:100:true }}
                    </p>
                  </div>

                  <!-- Insighter Info -->
                  <div class="meeting-participant">
                    <div class="d-flex align-items-center">
                      <div class="symbol symbol-40px me-3"
                           style="cursor: pointer;"
                           (click)="goToInsighterProfile(meeting.insighter.uuid)">
                        @if (meeting.insighter.profile_photo_url) {
                          <img [src]="meeting.insighter.profile_photo_url"
                               [alt]="meeting.insighter.name"
                               class="rounded-circle"
                               style="object-position: top;">
                        } @else {
                          <div class="symbol-label bg-primary text-white">
                            {{ getSentMeetingInitials(meeting.insighter.name) }}
                          </div>
                        }
                      </div>
                      <div class="flex-grow-1">
                        <div class="fw-bold text-gray-800"
                             style="cursor: pointer;"
                             (click)="goToInsighterProfile(meeting.insighter.uuid)"
                             [pTooltip]="meeting.insighter.name"
                             tooltipPosition="top"
                             [style.cursor]="meeting.insighter.name && meeting.insighter.name.length > 25 ? 'help' : 'pointer'">
                          {{ meeting.insighter.name | truncateText:25:true }}
                        </div>
                        <div class="text-muted fs-7">
                          {{ 'INSIGHTER.MEETINGS.INSIGHTER' | translate }}
                        </div>
                      </div>
                      <!-- Join Button -->
                      @if (canJoinMeeting(meeting)) {
                        <div class="ms-2">
                          <button type="button"
                                  class="btn btn-sm btn-secondary"
                                  (click)="joinMeeting(meeting.meeting_url)"
                                  [pTooltip]="'INSIGHTER.MEETINGS.JOIN_MEETING' | translate"
                                  tooltipPosition="top">
                            <i class="ki-duotone ki-entrance-right me-1">
                              <span class="path1"></span>
                              <span class="path2"></span>
                            </i>
                            {{ 'INSIGHTER.MEETINGS.JOIN' | translate }}
                          </button>
                        </div>
                      }
                      <!-- Reschedule Button -->
                      @if (canRescheduleMeeting(meeting)) {
                        <div class="ms-2">
                          <button type="button"
                                  class="btn btn-sm btn-light-warning"
                                  (click)="openRescheduleModal(meeting)"
                                  [pTooltip]="'INSIGHTER.MEETINGS.RESCHEDULE_MEETING' | translate"
                                  tooltipPosition="top">
                            <i class="ki-duotone ki-calendar-edit me-1">
                              <span class="path1"></span>
                              <span class="path2"></span>
                            </i>
                            {{ 'INSIGHTER.MEETINGS.RESCHEDULE' | translate }}
                          </button>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Sent Meetings Pagination -->
          @if (!sentLoading() && sentTotalPages() > 1) {
            <div class="row mt-5">
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="pagination-info text-muted">
                    {{ 'MEETINGS.SHOWING' | translate }}
                    {{ (sentCurrentPage() - 1) * perPage() + 1 }}
                    {{ 'MEETINGS.TO' | translate }}
                    {{ Math.min(sentCurrentPage() * perPage(), sentTotalItems()) }}
                    {{ 'MEETINGS.OF' | translate }}
                    {{ sentTotalItems() }}
                    {{ 'MEETINGS.RESULTS' | translate }}
                  </div>

                  <nav aria-label="Pagination">
                    <ul class="pagination pagination-outline">
                      <li class="page-item" [class.disabled]="sentCurrentPage() === 1">
                        @if (sentCurrentPage() > 1) {
                          <a class="page-link"
                             (click)="onMyMeetingsPageChange(sentCurrentPage() - 1)"
                             tabindex="0"
                             aria-label="Previous page"
                             (keydown.enter)="onMyMeetingsPageChange(sentCurrentPage() - 1)">
                            <i class="ki-duotone ki-black-left">
                              <span class="path1"></span>
                              <span class="path2"></span>
                            </i>
                          </a>
                        }
                      </li>

                      @for (page of getSentPageNumbers(); track page) {
                        <li class="page-item" [class.active]="sentCurrentPage() === page">
                          <a class="page-link"
                             (click)="onMyMeetingsPageChange(page)"
                             tabindex="0"
                             (keydown.enter)="onMyMeetingsPageChange(page)">
                            {{ page }}
                          </a>
                        </li>
                      }

                      <li class="page-item" [class.disabled]="sentCurrentPage() === sentTotalPages()">
                        @if (sentCurrentPage() < sentTotalPages()) {
                          <a class="page-link"
                             (click)="onMyMeetingsPageChange(sentCurrentPage() + 1)"
                             tabindex="0"
                             aria-label="Next page"
                             (keydown.enter)="onMyMeetingsPageChange(sentCurrentPage() + 1)">
                            <i class="ki-duotone ki-black-right">
                              <span class="path1"></span>
                              <span class="path2"></span>
                            </i>
                          </a>
                        }
                      </li>
                    </ul>
                  </nav>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </ng-container>
</div>

<!-- Approve Meeting Dialog -->
<p-dialog 
  header="Approve Meeting"
  [visible]="showApproveDialog()"
  [modal]="true" 
  [style]="{width: '500px'}"
  [draggable]="false"
  [resizable]="false"
  appendTo="body"
  [closable]="false"
  styleClass="custom-dialog"
  (onHide)="closeApproveDialog()">
  <div class="dialog-content">
    <div class="meeting-details mb-4">
      <h6 class="fw-bold mb-3">Meeting Details:</h6>
      <div class="detail-item">
        <strong>Title:</strong> 
        <span [pTooltip]="selectedMeeting()?.title || ''" 
              tooltipPosition="top"
              [style.cursor]="(selectedMeeting()?.title?.length || 0) > 50 ? 'help' : 'default'">
          {{ (selectedMeeting()?.title || '') | truncateText:50:true }}
        </span>
      </div>
      <div class="detail-item">
        <strong>Client:</strong> 
        <span [pTooltip]="selectedMeeting()?.client?.name || ''" 
              tooltipPosition="top"
              [style.cursor]="(selectedMeeting()?.client?.name?.length || 0) > 30 ? 'help' : 'default'">
          {{ (selectedMeeting()?.client?.name || '') | truncateText:30:true }}
        </span>
      </div>
      <div class="detail-item">
        <strong>Date:</strong> {{ selectedMeeting()?.date | date:'fullDate' }}
      </div>
      <div class="detail-item">
        <strong>Time:</strong> {{ formatTime(selectedMeeting()?.start_time || '') }} - {{ formatTime(selectedMeeting()?.end_time || '') }}
      </div>
    </div>
    
    <div class="form-group">
      <label for="approveNotes" class="form-label fw-bold">Approval Notes</label>
      <textarea 
        pInputTextarea 
        id="approveNotes" 
        [ngModel]="approveNotes()"
        (ngModelChange)="approveNotes.set($event)"
        placeholder="Enter approval notes for the client..."
        rows="4"
        class="w-100">
      </textarea>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button
      type="button"
      class="btn btn-light modal-btn-sm me-2"
      (click)="closeApproveDialog()">
      <i class="ki-duotone ki-cross fs-4">
        <span class="path1"></span>
        <span class="path2"></span>
      </i>
      Cancel
    </button>
    <button
      type="button"
      class="btn btn-success modal-btn-sm"
      [disabled]="actionLoading()"
      (click)="approveMeeting()">
      @if (!actionLoading()) {
        <i class="ki-duotone ki-check fs-4">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        Approve Meeting
      } @else {
        <span class="spinner-border spinner-border-sm" role="status"></span>
      }
    </button>
  </ng-template>
</p-dialog>

<!-- Postpone Meeting Dialog -->
<p-dialog 
  header="Postpone Meeting"
  [visible]="showPostponeDialog()"
  [modal]="true" 
  [style]="{width: '500px'}"
  [draggable]="false"
  [resizable]="false"
  appendTo="body"
  [closable]="false"
  styleClass="custom-dialog"
  (onHide)="closePostponeDialog()">
  
  <div class="dialog-content">
    <div class="meeting-details mb-4">
      <h6 class="fw-bold mb-3">Meeting Details:</h6>
      <div class="detail-item">
        <strong>Title:</strong> 
        <span [pTooltip]="selectedMeeting()?.title || ''" 
              tooltipPosition="top"
              [style.cursor]="(selectedMeeting()?.title?.length || 0) > 50 ? 'help' : 'default'">
          {{ (selectedMeeting()?.title || '') | truncateText:50:true }}
        </span>
      </div>
      <div class="detail-item">
        <strong>Client:</strong> 
        <span [pTooltip]="selectedMeeting()?.client?.name || ''" 
              tooltipPosition="top"
              [style.cursor]="(selectedMeeting()?.client?.name?.length || 0) > 30 ? 'help' : 'default'">
          {{ (selectedMeeting()?.client?.name || '') | truncateText:30:true }}
        </span>
      </div>
      <div class="detail-item">
        <strong>Date:</strong> {{ selectedMeeting()?.date | date:'fullDate' }}
      </div>
      <div class="detail-item">
        <strong>Time:</strong> {{ formatTime(selectedMeeting()?.start_time || '') }} - {{ formatTime(selectedMeeting()?.end_time || '') }}
      </div>
    </div>
    
    <div class="form-group">
      <label for="postponeNotes" class="form-label fw-bold">
        Postponement Notes <span class="text-danger">*</span>
      </label>
      <textarea 
        pInputTextarea 
        id="postponeNotes" 
        [ngModel]="postponeNotes()"
        (ngModelChange)="postponeNotes.set($event)"
        placeholder="Enter postponement reason and any additional information for the client..."
        rows="4"
        class="w-100"
        required>
      </textarea>
      @if (!postponeNotes() || postponeNotes().trim() === '') {
        <div class="text-muted fs-7 mt-1">
          <small>{{ 'MEETINGS.POSTPONE_NOTES_REQUIRED' | translate }}</small>
        </div>
      }
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button
      type="button"
      class="btn btn-light modal-btn-sm me-2"
      (click)="closePostponeDialog()">
      <i class="ki-duotone ki-cross fs-4">
        <span class="path1"></span>
        <span class="path2"></span>
      </i>
      Cancel
    </button>
    <button
      type="button"
      class="btn btn-warning modal-btn-sm"
      (click)="postponeMeeting()"
      [disabled]="actionLoading() || !postponeNotes() || postponeNotes().trim() === ''">
      @if (!actionLoading()) {
        <i class="ki-duotone ki-time fs-4">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        Postpone Meeting
      } @else {
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      }
    </button>
  </ng-template>
</p-dialog>

<!-- Reschedule Meeting Modal -->
<p-dialog
  [visible]="showRescheduleModal()"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [appendTo]="'body'"
  [style]="{width: '90vw', maxWidth: '1000px'}"
  [contentStyle]="{padding: '0'}"
  (onHide)="closeRescheduleModal()"
  styleClass="reschedule-modal">

  <!-- Header -->
  <ng-template pTemplate="header">
    <div class="d-flex align-items-center">
      <i class="ki-duotone ki-calendar-edit me-2 fs-2">
        <span class="path1"></span>
        <span class="path2"></span>
      </i>
      <span class="fw-bold fs-4">{{ 'INSIGHTER.MEETINGS.RESCHEDULE_MEETING' | translate }}</span>
    </div>
  </ng-template>

  <!-- Content -->
  <div class="p-4">
    <!-- Meeting Info -->
    @if (selectedMeetingForReschedule()) {
      <div class="mb-4">
        <div class="alert alert-info d-flex align-items-center">
          <i class="ki-duotone ki-information-5 fs-2x me-3">
            <span class="path1"></span>
            <span class="path2"></span>
            <span class="path3"></span>
          </i>
          <div>
            <strong>{{ selectedMeetingForReschedule()?.title }}</strong><br>
            <span class="text-muted">
              {{ 'INSIGHTER.MEETINGS.CURRENT_TIME' | translate }}:
              {{ formatDateForDisplay(selectedMeetingForReschedule()?.date || '') }},
              {{ formatTimeForDisplay(selectedMeetingForReschedule()?.start_time || '') }} -
              {{ formatTimeForDisplay(selectedMeetingForReschedule()?.end_time || '') }}
            </span>
          </div>
        </div>
      </div>
    }

    <!-- Paid Meeting Notice -->
    <div class="alert alert-warning d-flex align-items-center">
      <i class="ki-duotone ki-dollar fs-2x me-3 text-warning">
        <span class="path1"></span>
        <span class="path2"></span>
        <span class="path3"></span>
      </i>
      <div>
        <strong class="text-warning">Important Notice</strong><br>
        <span>This is a paid meeting. Rescheduling will not affect the payment status.</span>
      </div>
    </div>

    <!-- Loading State -->
    @if (rescheduleLoading()) {
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">{{ 'INSIGHTER.MEETINGS.LOADING_AVAILABLE_TIMES' | translate }}</p>
      </div>
    }

    <!-- Calendly-Style Calendar and Time Selection -->
    @if (!rescheduleLoading() && availableDays().length > 0) {
      <div class="calendly-container">
        <div class="row g-4">
          <!-- Left Column: Custom Calendar -->
          <div class="col-lg-6">
            <div class="calendar-section">
              <h3 class="calendar-title">Select a Date</h3>

              <!-- Month Navigation -->
              <div class="month-navigation">
                <button type="button" class="nav-btn" (click)="previousMonth()">
                  <i class="ki-duotone ki-left fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </button>
                <h4 class="month-title">{{ currentMonthName() }} {{ currentYear() }}</h4>
                <button type="button" class="nav-btn" (click)="nextMonth()">
                  <i class="ki-duotone ki-right fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                </button>
              </div>

              <!-- Weekday Headers -->
              <div class="weekday-headers">
                <div class="weekday-header">Sun</div>
                <div class="weekday-header">Mon</div>
                <div class="weekday-header">Tue</div>
                <div class="weekday-header">Wed</div>
                <div class="weekday-header">Thu</div>
                <div class="weekday-header">Fri</div>
                <div class="weekday-header">Sat</div>
              </div>

              <!-- Calendar Grid -->
              <div class="calendar-grid">
                <!-- Empty cells for days before the first day of the month -->
                @for (empty of getEmptyDays(); track $index) {
                  <div class="calendar-day empty"></div>
                }

                <!-- Days of the month -->
                @for (day of getDaysInCurrentMonth(); track day) {
                  <button type="button"
                          class="calendar-day"
                          [class.available]="isDateActive(getDateString(day))"
                          [class.selected]="selectedDate() === getDateString(day)"
                          [class.disabled]="!isDateActive(getDateString(day))"
                          [disabled]="!isDateActive(getDateString(day))"
                          (click)="selectDate(getDateString(day))">
                    {{ day }}
                  </button>
                }
              </div>
            </div>
          </div>

          <!-- Right Column: Time Selection -->
          <div class="col-lg-6">
            <div class="time-selection-section">
              @if (selectedDate()) {
                <div class="selected-date-header">
                  <h3 class="selected-date-title">{{ getFormattedSelectedDate() }}</h3>
                </div>
              }

              <div class="time-slots" *ngIf="selectedDate()">
                @for (timeSlot of getAvailableTimesForDate(selectedDate()); track timeSlot) {
                  <div class="time-slot-item"
                       [class.selected]="selectedTimeSlot() === timeSlot"
                       (click)="selectTimeSlot(timeSlot)">
                    {{ formatTimeForDisplay(timeSlot.start_time) }} - {{ formatTimeForDisplay(timeSlot.end_time) }}
                  </div>
                }

                @if (getAvailableTimesForDate(selectedDate()).length === 0) {
                  <div class="no-times">
                    No times available for this date
                  </div>
                }
              </div>

              @if (!selectedDate()) {
                <div class="select-date-prompt">
                  <i class="ki-duotone ki-calendar-8 fs-3x text-gray-300 mb-3">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                    <span class="path4"></span>
                    <span class="path5"></span>
                    <span class="path6"></span>
                  </i>
                  <p>Please select a date to view available times</p>
                </div>
              }

              <!-- Warning for same time selection -->
              @if (selectedTimeSlot() && !isDifferentTime()) {
                <div class="same-time-warning">
                  <i class="ki-duotone ki-warning me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                  </i>
                  {{ 'INSIGHTER.MEETINGS.SAME_TIME_WARNING' | translate }}
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }

    <!-- No Available Times -->
    @if (!rescheduleLoading() && availableDays().length === 0) {
      <div class="text-center py-5">
        <i class="ki-duotone ki-calendar-remove fs-3x text-gray-400 mb-3">
          <span class="path1"></span>
          <span class="path2"></span>
          <span class="path3"></span>
        </i>
        <h6 class="text-gray-700 mb-2">{{ 'INSIGHTER.MEETINGS.NO_AVAILABLE_TIMES' | translate }}</h6>
        <p class="text-gray-500">{{ 'INSIGHTER.MEETINGS.NO_AVAILABLE_TIMES_DESC' | translate }}</p>
      </div>
    }
  </div>

  <!-- Footer -->
  <ng-template pTemplate="footer">
    <div class="d-flex justify-content-end gap-2 p-3">
      <button type="button"
              class="btn btn-light modal-btn-sm"
              (click)="closeRescheduleModal()">
        {{ 'COMMON.CANCEL' | translate }}
      </button>
      <button type="button"
              class="btn btn-primary modal-btn-sm"
              [disabled]="!selectedTimeSlot() || !isDifferentTime() || rescheduleLoading()"
              (click)="confirmReschedule()">
        @if (rescheduleLoading()) {
          <span class="spinner-border spinner-border-sm" role="status"></span>
        } @else {
          {{ 'INSIGHTER.MEETINGS.RESCHEDULE' | translate }}
        }
      </button>
    </div>
  </ng-template>
</p-dialog>