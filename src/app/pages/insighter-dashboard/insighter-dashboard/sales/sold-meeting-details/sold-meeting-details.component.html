<!-- Insighter Filter positioned at the end (only for company users) -->
<div class="d-flex flex-column flex-sm-row mb-4" [ngClass]="lang === 'ar' ? 'justify-content-start' : 'justify-content-end'" *ngIf="shouldShowInsighterFilter">
  <div class="w-100" style="max-width: 300px;">
    <app-insighter-filter
      [lang]="lang"
      [selectedInsighterUuid]="selectedInsighterUuid"
      (insighterSelected)="onInsighterFilterChange($event)">
    </app-insighter-filter>
  </div>
</div>

<div class="row g-4">
  <!-- Loading State -->
  <div *ngIf="isMeetingSalesLoading$ | async" class="col-12">
    <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
      <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">{{ lang === 'ar' ? 'جاري التحميل...' : 'Loading...' }}</span>
      </div>
    </div>
  </div>

  <!-- Meeting Orders Cards -->
  <ng-container *ngIf="!(isMeetingSalesLoading$ | async)">
    <div *ngFor="let order of meetingSalesOrders$ | async" class="col-12">
      <div class="card card-custom gutter-b">
        <div class="card-body p-6">
          <!-- Order Header -->
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-6 gap-3">
            <div class="d-flex align-items-center flex-grow-1">
              <div class="symbol symbol-40px me-3">
                <div class="symbol-label bg-light-info">
                  <i class="ki-outline ki-calendar fs-2x text-info"></i>
                </div>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex align-items-center flex-wrap mb-1">
                  <h6 class="mb-0 fw-bold me-2">
                    <a [routerLink]="['/app/insighter-dashboard/my-meetings']" [queryParams]="{ tab: 'client' }">
                      {{ lang === 'ar' ? 'طلب رقم' : 'Order' }} {{ order.order_no }}
                    </a>
                  </h6>
                  <i (click)="copyOrder(order.order_no)" class="ki-outline ki-copy fs-6 cursor-pointer"></i>
                </div>
                <!-- Insighter Information -->
                <div class="d-flex align-items-center flex-wrap mb-1" *ngIf="order.orderable.meeting_booking?.insighter">
                  <div class="symbol symbol-25px me-2">
                    <img *ngIf="order.orderable.meeting_booking?.insighter?.profile_photo_url"
                         [src]="order.orderable.meeting_booking?.insighter?.profile_photo_url"
                         [alt]="order.orderable.meeting_booking?.insighter?.name"
                         class="symbol-label rounded-circle"
                         style="object-fit: cover; object-position: top;">
                    <div *ngIf="!order.orderable.meeting_booking?.insighter?.profile_photo_url"
                         class="symbol-label bg-light-info rounded-circle d-flex align-items-center justify-content-center">
                      <span class="text-info fw-bold fs-8">
                        {{ (order.orderable.meeting_booking?.insighter?.first_name?.charAt(0) || '') + (order.orderable.meeting_booking?.insighter?.last_name?.charAt(0) || '') }}
                      </span>
                    </div>
                  </div>
                  <a *ngIf="order.orderable.meeting_booking?.insighter?.uuid; else justInsighterName"
                     [href]="'https://insightabusiness.com/' + lang + '/profile/' + order.orderable.meeting_booking?.insighter?.uuid + '?entity=insighter'"
                     target="_blank"
                     class="text-info text-decoration-none fs-7 me-2">
                    {{ order.orderable.meeting_booking?.insighter?.name }}
                  </a>
                  <ng-template #justInsighterName>
                    <span class="text-muted fs-7 me-2">{{ order.orderable.meeting_booking?.insighter?.name }}</span>
                  </ng-template>
                  <span class="badge badge-light-success ms-auto ms-md-2 mb-0">
                    {{ lang === 'ar' ? 'خبير' : 'Insighter' }}
                  </span>
                </div>
              </div>
            </div>
            <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
              <button
                type="button"
                class="btn btn-info btn-sm"
                (click)="selectOrder(order)">
                <span class="d-none d-sm-inline">{{ lang === 'ar' ? 'تفاصيل الطلب' : 'Order Details' }}</span>
                <span class="d-sm-none">{{ lang === 'ar' ? 'التفاصيل' : 'Details' }}</span>
              </button>
              <button
                type="button"
                class="btn btn-light-info btn-sm"
                (click)="downloadInvoice(order)">
                <i class="ki-outline ki-file-down fs-6 me-1"></i>
                <span class="d-none d-sm-inline">{{ lang === 'ar' ? 'تحميل الفاتورة' : 'Download Invoice' }}</span>
                <span class="d-sm-none">{{ lang === 'ar' ? 'الفاتورة' : 'Invoice' }}</span>
              </button>
            </div>
          </div>

          <!-- Meeting Details -->
          <div *ngIf="order.orderable" class="mb-3">
            <div *ngIf="order.orderable.meeting_booking" class="bg-light-info rounded p-4">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3 gap-2">
                <div class="flex-grow-1">
                  <h6 class="mb-1 fw-bold text-dark">{{ order.orderable.meeting_booking.title }}</h6>
                  <p class="text-muted fs-7 mb-0">{{ order.orderable.meeting_booking.description }}</p>
                </div>
                <span class="badge text-capitalize align-self-start"
                      [ngClass]="{
                        'badge-light-success': order.orderable.meeting_booking.status === 'approved',
                        'badge-light-warning': order.orderable.meeting_booking.status === 'pending',
                        'badge-light-danger': order.orderable.meeting_booking.status === 'rejected',
                        'badge-light-info': order.orderable.meeting_booking.status !== 'approved' && order.orderable.meeting_booking.status !== 'pending' && order.orderable.meeting_booking.status !== 'rejected'
                      }">
                  {{ order.orderable.meeting_booking.status_name }}
                </span>
              </div>

              <div class="row g-3 mt-2">
                <div class="col-12 col-sm-6 col-lg-3" *ngIf="order.user">
                  <div class="d-flex align-items-center">
                    <div class="symbol symbol-30px me-2">
                      <a *ngIf="order.user.uuid"
                         [href]="'https://insightabusiness.com/' + lang + '/profile/' + order.user.uuid + '?entity=insighter'"
                         target="_blank"
                         class="text-decoration-none d-block">
                        <img *ngIf="order.user.profile_photo_url"
                             [src]="order.user.profile_photo_url"
                             [alt]="order.user.name"
                             class="symbol-label rounded-circle"
                             style="object-fit: cover; object-position: top;">
                        <div *ngIf="!order.user.profile_photo_url"
                             class="symbol-label bg-light-primary rounded-circle d-flex align-items-center justify-content-center">
                          <span class="text-primary fw-bold fs-8">
                            {{ (order.user.first_name?.charAt(0) || '') + (order.user.last_name?.charAt(0) || '') }}
                          </span>
                        </div>
                      </a>
                      <div *ngIf="!order.user.uuid">
                        <img *ngIf="order.user.profile_photo_url"
                             [src]="order.user.profile_photo_url"
                             [alt]="order.user.name"
                             class="symbol-label rounded-circle"
                             style="object-fit: cover; object-position: top;">
                        <div *ngIf="!order.user.profile_photo_url"
                             class="symbol-label bg-light-primary rounded-circle d-flex align-items-center justify-content-center">
                          <span class="text-primary fw-bold fs-8">
                            {{ (order.user.first_name?.charAt(0) || '') + (order.user.last_name?.charAt(0) || '') }}
                          </span>
                        </div>
                      </div>
                    </div>
                    <div>
                      <div class="fs-8 text-muted">{{ lang === 'ar' ? 'الجلسة الاستشارية مع' : 'Session with' }}</div>
                      <div class="fw-semibold fs-7">
                        <a *ngIf="order.user.uuid; else justUserName"
                           [href]="'https://insightabusiness.com/' + lang + '/profile/' + order.user.uuid + '?entity=insighter'"
                           target="_blank"
                           class="text-primary text-decoration-none">
                          {{ order.user.name }}
                        </a>
                        <ng-template #justUserName>
                          <span class="text-dark">{{ order.user.name }}</span>
                        </ng-template>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                  <div class="d-flex align-items-center">
                    <i class="ki-outline ki-calendar fs-5 text-info me-2"></i>
                    <div>
                      <div class="fs-8 text-muted">{{ lang === 'ar' ? 'التاريخ' : 'Date' }}</div>
                      <div class="fw-semibold fs-7">{{ order.orderable.meeting_booking.date | date:'mediumDate' }}</div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                  <div class="d-flex align-items-center">
                    <i class="ki-outline ki-time fs-5 text-info me-2"></i>
                    <div>
                      <div class="fs-8 text-muted">{{ lang === 'ar' ? 'الوقت' : 'Time' }}</div>
                      <div class="fw-semibold fs-7">{{ order.orderable.meeting_booking.start_time }} - {{ order.orderable.meeting_booking.end_time }}</div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                  <div class="d-flex align-items-center">
                    <i class="ki-outline ki-timer fs-5 text-info me-2"></i>
                    <div>
                      <div class="fs-8 text-muted">{{ lang === 'ar' ? 'المدة' : 'Duration' }}</div>
                      <div class="fw-semibold fs-7">{{ utils.calculateDuration(lang, order.orderable.meeting_booking.start_time, order.orderable.meeting_booking.end_time) }}</div>
                    </div>
                  </div>
                </div>
              
              </div>
            </div>
          </div>

          <!-- Order Date and Amount -->
          <div class="border-top pt-3 mt-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted fs-7">
                {{ lang === 'ar' ? 'تاريخ الطلب' : 'Ordered' }} {{ order.date | date:'short' }}
              </div>
              <div class="fw-bold text-dark fs-6">
                ${{ order.amount }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Empty State -->
  <div *ngIf="(meetingSalesOrders$ | async)?.length === 0 && !(isMeetingSalesLoading$ | async)" class="col-12">
    <div class="text-center py-10">
      <div class="symbol symbol-100px mx-auto mb-4">
        <div class="symbol-label bg-light-success">
          <i class="ki-outline ki-briefcase fs-3x text-success"></i>
        </div>
      </div>
      <h5 class="mb-3">{{ lang === 'ar' ? 'لا توجد اجتماعات مباعة' : 'No Sales Meetings Found' }}</h5>
      <p class="text-muted">
        {{ lang === 'ar' ? 'لم تقم ببيع أي اجتماعات بعد' : 'You have no sales meetings yet.' }}
      </p>
    </div>
  </div>
</div>

<!-- Pagination -->
<div *ngIf="(meetingSalesTotalPages$ | async)! > 1" class="d-flex justify-content-center mt-6">
  <p-paginator
    [rows]="10"
    [totalRecords]="(meetingSalesTotalPages$ | async)! * 10"
    [first]="(currentMeetingSalesPage - 1) * 10"
    (onPageChange)="onMeetingSalesPageChange($event)"
    [showCurrentPageReport]="true"
    [currentPageReportTemplate]="lang === 'ar' ? 'عرض {first} إلى {last} من {totalRecords} اجتماع' : 'Showing {first} to {last} of {totalRecords} meetings'">
  </p-paginator>
</div>