<p-dialog
  [(visible)]="showModal"
  [modal]="true"
  [style]="{width: '450px'}"
  [closable]="false"
  [closeOnEscape]="false"
  [dismissableMask]="false"
  [draggable]="false"
  [resizable]="false"
  [focusOnShow]="true"
  [blockScroll]="true"
  appendTo="body"
  styleClass="country-update-dialog"
>
  <ng-template pTemplate="header">
    <div class="d-flex align-items-center">
      <i class="ki-outline ki-geolocation fs-1 text-info me-3"></i>
      <h5 class="m-0">
        {{ lang === 'ar' ? 'تحديث البلد' : 'Update Country' }}
      </h5>
    </div>
  </ng-template>

  <div class="py-4">
    <div class="alert alert-info border-0 mb-4">
      <div class="d-flex align-items-center">
        <i class="ki-outline ki-information-5 fs-2 text-info me-3"></i>
        <div>
          <p class="mb-1 fw-semibold">
            {{ lang === 'ar' ? 'مطلوب تحديث البلد' : 'Country Update Required' }}
          </p>
          <p class="mb-0 text-muted fs-7">
            {{ lang === 'ar'
              ? 'يرجى تحديد بلدك للمتابعة إلى لوحة المعلومات'
              : 'Please select your country to continue to the dashboard'
            }}
          </p>
        </div>
      </div>
    </div>

    <form [formGroup]="countryForm" (ngSubmit)="onSubmit()" class="form">
      <div class="fv-row mb-4">
        <label class="form-label fw-semibold mb-2">
          {{ lang === 'ar' ? 'البلد' : 'Country' }} *
        </label>

        <span class="spinner-border spinner-border-sm text-info me-2" *ngIf="(isLoadingCountries$ | async)"></span>

        <p-dropdown
          *ngIf="(isLoadingCountries$ | async) === false"
          [options]="countries"
          formControlName="country"
          appendTo="body"
          [class]="'d-block form-p-control' + (lang === 'ar' ? ' rtl-dropdown' : '')"
          [optionLabel]="lang=='en' ? 'names.en' : 'names.ar'"
          [placeholder]="lang === 'ar' ? 'اختر البلد' : 'Select Country'"
          [filter]="true"
          [showClear]="true"
          [dir]="lang === 'ar' ? 'rtl' : 'ltr'"
          [ngClass]="{
            'is-invalid':
              countryForm.controls['country'].invalid &&
              (countryForm.controls['country'].dirty || countryForm.controls['country'].touched)
          }"
        >
          <ng-template pTemplate="item" let-country>
            <div class="country-option" [class]="lang === 'ar' ? 'rtl-country-option' : 'ltr-country-option'">
              <img *ngIf="country.showFlag" style="width: 40px; height: 20px;"
                [src]="country.flagPath"
                (error)="onFlagError(country)"
                [alt]="country.names.en"
                [class]="'flag-icon w-20px ' + (lang === 'ar' ? 'ms-2' : 'me-2')" />
              <span *ngIf="lang=='en'" class="country-name">{{ country.names.en }}</span>
              <span *ngIf="lang=='ar'" class="country-name">{{ country.names.ar }}</span>
            </div>
          </ng-template>

          <ng-template pTemplate="selectedItem" let-country>
            <div class="selected-country-option" [class]="lang === 'ar' ? 'rtl-selected-option' : 'ltr-selected-option'" *ngIf="country">
              <img *ngIf="country.showFlag"
                [src]="country.flagPath"
                (error)="onFlagError(country)"
                [alt]="country.names.en"
                [class]="'flag-icon w-20px ' + (lang === 'ar' ? 'ms-2' : 'me-2')" />
              <span *ngIf="lang=='en'" class="country-name">{{ country.names.en }}</span>
              <span *ngIf="lang=='ar'" class="country-name">{{ country.names.ar }}</span>
            </div>
          </ng-template>
        </p-dropdown>

        <div *ngIf="countryForm.controls['country'].invalid && (countryForm.controls['country'].dirty || countryForm.controls['country'].touched)" class="text-danger mt-1 fs-8">
          {{ lang === 'ar' ? 'البلد مطلوب' : 'Country is required' }}
        </div>
      </div>
    </form>
  </div>

  <ng-template pTemplate="footer">
    <div class="d-flex justify-content-end gap-2">
      <button
        type="submit"
        [disabled]="(isLoadingSubmit$ | async) || countryForm.invalid"
        class="btn btn-info"
        (click)="onSubmit()"
      >
        <ng-container *ngIf="(isLoadingSubmit$ | async) === false">
          <i class="ki-outline ki-check fs-2 me-2"></i>
          {{ lang === 'ar' ? 'تحديث' : 'Update' }}
        </ng-container>
        <ng-container *ngIf="isLoadingSubmit$ | async">
          <span class="spinner-border spinner-border-sm me-2"></span>
          {{ lang === 'ar' ? 'جاري التحديث...' : 'Updating...' }}
        </ng-container>
      </button>
    </div>
  </ng-template>
</p-dialog>