<div class="pt-5 py-10">
  <div class="card-header p-5">
    <h2 class="page-title">Orders Management</h2>
  </div>
  
  <div class="table-container">
    <p-table #dt 
      [value]="orders" 
      [paginator]="true" 
      [rows]="rows" 
      [totalRecords]="totalRecords"
      [lazy]="true"
      (onLazyLoad)="loadOrders($event)"
      [loading]="loading"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} orders"
      styleClass="p-datatable-sm p-datatable-striped">
      
      <ng-template pTemplate="header">
        <tr>
          <th>Order No</th>
          <th>Date</th>
          <th>Service</th>
          <th>Amount</th>
          <th>Payment Status</th>
          <th>Payment Method</th>
          <th>Fulfillment Status</th>
          <th>Invoice No</th>
          <th>Actions</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-order>
        <tr>
          <td>
            <strong>{{ order.order_no }}</strong>
          </td>
          <td>{{ formatDate(order.date) }}</td>
          <td>
            <span class="badge badge-light-info">{{ order.service | serviceName }}</span>
          </td>
          <td>{{ formatCurrency(order.amount, order.currency) }}</td>
          <td>
            <span class="badge" [ngClass]="getStatusBadgeClass(order.status)">{{ order.status | titlecase }}</span>
          </td>
          <td>
            <span class="badge badge-light-secondary">{{ getPaymentMethodLabel(order.payment.method) }}</span>
          </td>
          <td>
            <span class="badge" [ngClass]="getFulfillmentBadgeClass(order.fulfillment_staus)">{{ order.fulfillment_staus | titlecase }}</span>
          </td>
          <td>{{ order.invoice_no }}</td>
          <td>
            <button pButton 
              type="button" 
              icon="pi pi-eye" 
              class="p-button-rounded p-button-text p-button-info"
              (click)="showOrderDetails(order)"
              pTooltip="View Details">
            </button>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center">No orders found.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Order Details Dialog -->
<p-dialog [(visible)]="displayDialog" 
  [modal]="true" 
  [style]="{width: '90vw', maxWidth: '1200px'}"
  [maximizable]="true"
  [header]="'Order Details - ' + (selectedOrder?.order_no || '')"
  [draggable]="false"
  [resizable]="false"
  styleClass="order-details-dialog">
  
  <div *ngIf="selectedOrder" class="order-details">
    <!-- Header Section with Key Information -->
    <div class="detail-header">
      <div class="header-grid">
        <div class="header-item">
          <i class="pi pi-hashtag header-icon"></i>
          <div class="header-content">
            <span class="header-label">Order Number</span>
            <span class="header-value">{{ selectedOrder.order_no }}</span>
          </div>
        </div>
        <div class="header-item">
          <i class="pi pi-file header-icon"></i>
          <div class="header-content">
            <span class="header-label">Invoice Number</span>
            <span class="header-value">{{ selectedOrder.invoice_no }}</span>
          </div>
        </div>
        <div class="header-item">
          <i class="pi pi-calendar header-icon"></i>
          <div class="header-content">
            <span class="header-label">Order Date</span>
            <span class="header-value">{{ formatDate(selectedOrder.date) }}</span>
          </div>
        </div>
        <div class="header-item">
          <i class="pi pi-dollar header-icon"></i>
          <div class="header-content">
            <span class="header-label">Total Amount</span>
            <span class="header-value amount">{{ formatCurrency(selectedOrder.amount, selectedOrder.currency) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Cards -->
    <div class="status-section">
      <div class="status-card">
        <div class="status-header">
          <i class="pi pi-credit-card"></i>
          <span>Payment Information</span>
        </div>
        <div class="status-body">
          <div class="status-row">
            <span class="status-label">Method:</span>
            <span class="badge badge-light-secondary">{{ getPaymentMethodLabel(selectedOrder.payment.method) }}</span>
          </div>
          <div class="status-row">
            <span class="status-label">Status:</span>
            <span class="badge" [ngClass]="getStatusBadgeClass(selectedOrder.payment.status)">{{ selectedOrder.payment.status | titlecase }}</span>
          </div>
          <div class="status-row" *ngIf="selectedOrder.payment.provider">
            <span class="status-label">Provider:</span>
            <span class="status-value">{{ selectedOrder.payment.provider }}</span>
          </div>
          <div class="status-row" *ngIf="selectedOrder.payment.confirmed_at">
            <span class="status-label">Confirmed:</span>
            <span class="status-value">{{ formatDate(selectedOrder.payment.confirmed_at) }}</span>
          </div>
        </div>
      </div>

      <div class="status-card">
        <div class="status-header">
          <i class="pi pi-truck"></i>
          <span>Fulfillment Status</span>
        </div>
        <div class="status-body">
          <div class="status-row">
            <span class="status-label">Status:</span>
            <span class="badge" [ngClass]="getFulfillmentBadgeClass(selectedOrder.fulfillment_staus)">{{ selectedOrder.fulfillment_staus | titlecase }}</span>
          </div>
          <div class="status-row">
            <span class="status-label">Service:</span>
            <span class="badge badge-light-info">{{ selectedOrder.service | serviceName }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Items Section -->
    <div class="items-section" *ngIf="selectedOrder.order_data">
      <h3 class="section-title">
        <i class="pi pi-shopping-cart"></i>
        Order Items
      </h3>

      <div class="order_datas-container">
        <div class="order_data-card">
          <div class="order_data-header">
            <span class="order_data-number">Order Contents</span>
          </div>

          <!-- Knowledge Items -->
          <div class="knowledge-section" *ngIf="selectedOrder.order_data.knowledge && selectedOrder.order_data.knowledge.length > 0">
            <h4 class="subsection-title">Knowledge Products</h4>
            <div class="knowledge-items">
              <div class="knowledge-item" *ngFor="let item of selectedOrder.order_data.knowledge">
                <div class="knowledge-type">
                  <p-chip [label]="item.type" styleClass="custom-chip"></p-chip>
                </div>
                <div class="knowledge-title">{{ item.title }}</div>
              </div>
            </div>
          </div>

          <!-- Documents -->
          <div class="documents-section" *ngIf="selectedOrder.order_data.knowledge_documents && selectedOrder.order_data.knowledge_documents.length > 0">
            <h4 class="subsection-title">Documents</h4>
            <div class="documents-grid">
              <div *ngFor="let docGroup of selectedOrder.order_data.knowledge_documents">
                <div class="document-item" *ngFor="let doc of docGroup">
                  <img [src]="getFileIcon(doc.file_extension)"
                       [alt]="doc.file_extension"
                       class="file-icon">
                  <div class="document-info">
                    <span class="document-name">{{ doc.file_name }}.{{ doc.file_extension }}</span>
                    <span class="document-price">{{ formatCurrency(doc.price, selectedOrder.currency) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Fulfillment Timeline -->
    <div class="timeline-section" *ngIf="selectedOrder.fulfillment_attempts && selectedOrder.fulfillment_attempts.length > 0">
      <h3 class="section-title">
        <i class="pi pi-history"></i>
        Fulfillment Timeline
      </h3>
      
      <div class="timeline">
        <div class="timeline-item" *ngFor="let attempt of selectedOrder.fulfillment_attempts">
          <div class="timeline-marker" [class.success]="attempt.status === 'succeeded'" [class.failed]="attempt.status !== 'succeeded'">
            <i class="pi" [ngClass]="attempt.status === 'succeeded' ? 'pi-check' : 'pi-times'"></i>
          </div>
          <div class="timeline-content">
            <div class="timeline-header">
              <div class="timeline-user">
                <img *ngIf="attempt.user.profile_photo_url" 
                     [src]="attempt.user.profile_photo_url" 
                     [alt]="attempt.user.name"
                         style="object-fit: cover; object-position: top;"
                     class="user-avatar">
                <div class="user-info">
                  <span class="user-name">{{ attempt.user.name }}</span>
                  <span class="user-email">{{ attempt.user.email }}</span>
                </div>
              </div>
              <span class="timeline-date">{{ formatDate(attempt.attempted_at) }}</span>
            </div>
            <div class="timeline-body">
              <div class="timeline-details">
                <span class="badge badge-light-info">{{ attempt.step | titlecase }}</span>
                <span class="badge" [ngClass]="attempt.status === 'succeeded' ? 'badge-light-success' : 'badge-light-danger'">{{ attempt.status | titlecase }}</span>
                <span class="retry-info" *ngIf="attempt.retry_count > 0">
                  Retries: {{ attempt.retry_count }}
                </span>
              </div>
              <div class="error-message" *ngIf="attempt.error_message">
                <i class="pi pi-exclamation-triangle"></i>
                {{ attempt.error_message }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button pButton type="button" label="Close" icon="pi pi-times" class="p-button-secondary" (click)="displayDialog = false"></button>
    </div>
  </ng-template>
</p-dialog>