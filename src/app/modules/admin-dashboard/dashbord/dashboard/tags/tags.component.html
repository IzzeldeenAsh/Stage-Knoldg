<p-progressBar
*ngIf="isLoading$ | async"
mode="indeterminate"
[style]="{ height: '4px' }"
/>

<ng-container *ngIf="!(isLoading$ | async)">
<div id="kt_app_toolbar" class="app-toolbar pt-10 px-10 pb-0 mb-0">
  <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex align-items-stretch">
    <div class="app-toolbar-wrapper d-flex flex-stack flex-wrap gap-4 w-100">
      <div class="page-title d-flex flex-column justify-content-center gap-1 me-3">
        <h1 class="page-heading d-flex flex-column justify-content-center text-gray-900 fw-bold fs-3 m-0">
          Tags
        </h1>
        <div class="fw-semibold fs-7 my-0 text-muted">{{paginationData?.totalRecords || 0}} Tags</div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="d-flex align-items-center position-relative">
          <i class="pi pi-search position-absolute ms-3" style="font-size: 14px; color: #6c757d;"></i>
          <input
              type="text"
              pInputText
              class="form-control ps-10"
              style="width: 240px; height: 36px; border: 1px solid #cbd5e1; border-radius: 6px;"
              placeholder="Search"
              [(ngModel)]="searchKeyword"
              (keyup.enter)="onSearch()"
          />
        </div>
        <p-dropdown
          appendTo="body"
          id="statusFilter"
          [(ngModel)]="statusFilter"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Status"
          (onChange)="onStatusFilterChange()"
          [style]="{ 'height': '36px', 'min-width': '120px', 'border': '1px solid #cbd5e1', 'border-radius': '6px' }"
        ></p-dropdown>
        <button 
          (click)="showDialog()" 
          class="btn btn-sm d-flex align-items-center "
          style="background: white; border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px 12px; height: 36px; white-space: nowrap;"
        >
          <i class="ki-outline ki-plus fs-5" style="color: #3b82f6;"></i>
          <span class="ms-1" style="font-size: 13px; font-weight: 500; color: #374151;">Create</span>
        </button>
      </div>

    
    </div>
  </div>
</div>
<p-dialog appendTo="body" [header]="isEditMode ? 'Edit Tag' : 'Add Tag'" [modal]="true" [(visible)]="visible" [style]="{ width: '40rem' }">
          
          <p-messages *ngIf="hasErrorMessage" [(value)]="messages" [enableService]="false"></p-messages>
          <span class="text-muted mb-3 d-block">
            {{ isEditMode ? 'Edit Tag Details' : 'Add Tag Details' }}.
          </span>

          <form [formGroup]="tagForm" (ngSubmit)="submit()">
            <!-- English Name -->
            <div class="mb-3 row">
              <label for="englishName" class="col-sm-3 col-form-label">English Name <span class="text-danger">*</span></label>
              <div class="col-sm-9">
                <input 
                  pInputText 
                  id="englishName" 
                  class="form-control" 
                  formControlName="englishName" 
                  autocomplete="off" 
                  placeholder="Enter English name"
                />
                <div *ngIf="englishName?.errors?.required && englishName?.touched" class="text-danger mt-1">
                  English Name is required.
                </div>
                <div *ngIf="englishName?.errors?.serverError" class="text-danger mt-1">
                  {{ englishName?.errors?.serverError }}
                </div>
              </div>
            </div>

            <!-- Arabic Name -->
            <div class="mb-3 row">
              <label for="arabicName" class="col-sm-3 col-form-label">Arabic Name <span class="text-danger">*</span></label>
              <div class="col-sm-9">
                <input 
                  pInputText 
                  id="arabicName" 
                  class="form-control" 
                  formControlName="arabicName" 
                  autocomplete="off" 
                  placeholder="Enter Arabic name"
                />
                <div *ngIf="arabicName?.errors?.required && arabicName?.touched" class="text-danger mt-1">
                  Arabic Name is required.
                </div>
                <div *ngIf="arabicName?.errors?.serverError" class="text-danger mt-1">
                  {{ arabicName?.errors?.serverError }}
                </div>
              </div>
            </div>

            <!-- Status -->
            <div class="mb-3 row">
              <label for="status" class="col-sm-3 col-form-label">Status <span class="text-danger">*</span></label>
              <div class="col-sm-9">
                <p-dropdown 
                  id="status"
                  formControlName="status"
                  [options]="[
                    { label: 'Active', value: 'active' },
                    { label: 'Inactive', value: 'inactive' },
                    { label: 'Suggestion', value: 'suggestion' }
                  ]"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Select Status"
                  styleClass="w-100"
                ></p-dropdown>
                <div *ngIf="status?.errors?.required && status?.touched" class="text-danger mt-1">
                  Status is required.
                </div>
                <div *ngIf="status?.errors?.serverError" class="text-danger mt-1">
                  {{ status?.errors?.serverError }}
                </div>
              </div>
            </div>

            <!-- Industries -->
            <div class="mb-3 row">
              <label for="industries" class="col-sm-3 col-form-label">Industries</label>
              <div class="col-sm-9">
                <p-multiSelect
                  id="industries"
                  [(ngModel)]="selectedIndustries"
                  [ngModelOptions]="{standalone: true}"
                  [options]="industriesList"
                  optionLabel="name"
                  appendTo="body"
                  placeholder="Select Industries"
                  [showToggleAll]="true"
                  [filter]="true"
                  filterPlaceholder="Search industries..."
                  styleClass="w-100"
                  [maxSelectedLabels]="3"
                  selectedItemsLabel="{0} industries selected"
                ></p-multiSelect>
                <div *ngIf="industries?.errors?.serverError" class="text-danger mt-1">
                  {{ industries?.errors?.serverError }}
                </div>
              </div>
            </div>
          </form>

          <!-- Dialog Footer -->
          <div class="d-flex justify-content-end gap-2 mt-4">
            <button
              type="button"
              [disabled]="tagForm.invalid || (isLoading$ | async)"
              (click)="submit()"
              class="btn btn-primary btn-sm"
            >
              <ng-container *ngIf="!(isLoading$ | async)">
                <span class="indicator-label">{{ isEditMode ? 'Update' : 'Create' }}</span>
              </ng-container>
              <ng-container *ngIf="isLoading$ | async">
                <span class="indicator-progress" style="display: block;">
                  Please wait
                  <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                </span>
              </ng-container>
            </button>
            <button (click)="onCancel()" class="btn btn-outline-secondary btn-sm">
              Cancel
            </button>
          </div>
        </p-dialog>

<div id="kt_app_content" class="app-content px-10 pb-10 pt-5 flex-column-fluid">
  <div id="kt_app_content_container" class="app-container container-fluid">
    
    <ng-container *ngIf="(isLoading$ | async) === false && tagsWithIndustries.length > 0">
      <p-table
        #dt
        [value]="tagsWithIndustries"
        [paginator]="true"
        [rows]="10"
        [loading]="isLoading$ | async"
        [globalFilterFields]="['names.en', 'names.ar', 'status']"
        responsiveLayout="scroll"
        [rowHover]="true"
        [tableStyle]="{'width': '100%'}"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 20%">Name (English)</th>
            <th style="width: 20%">Name (Arabic)</th>
            <th style="width: 12%">Status</th>
            <th style="width: 33%">Associated Industries</th>
            <th style="width: 15%"></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-tag>
          <tr>
            <td>
              <span class="text-gray-800 fw-semibold">{{ tag.names.en }}</span>
            </td>
            <td>
              <span class="text-gray-700">{{ tag.names.ar }}</span>
            </td>
            <td>
              <span class="px-3 py-1 rounded fw-semibold" style="font-size: 12px;" [ngStyle]="{
                  'background-color': tag.status === 'active' ? '#d1eddb' : tag.status === 'inactive' ? '#f8d7da' : '#fff3cd',
                  'color': tag.status === 'active' ? '#155724' : tag.status === 'inactive' ? '#721c24' : '#856404'
              }">
                  {{ tag.status }}
              </span>
            </td>
            <td>
              <div class="d-flex flex-wrap gap-1" *ngIf="tag.industryNames.length > 0; else noIndustries">
                <span 
                  *ngFor="let industryName of tag.industryNames.slice(0, 3)" 
                  class="badge badge-light-primary fs-8 fw-semibold"
                >
                  {{ industryName }}
                </span>
                <span 
                  *ngIf="tag.industryNames.length > 3" 
                  class="badge badge-light fs-8 fw-semibold"
                  [pTooltip]="tag.industryNames.slice(3).join(', ')"
                  tooltipPosition="top"
                >
                  +{{ tag.industryNames.length - 3 }} more
                </span>
              </div>
              <ng-template #noIndustries>
                <span class="text-gray-500" style="font-size: 13px;">No industries assigned</span>
              </ng-template>
            </td>
            <td>
              <div class="d-flex justify-content-end gap-1">
                <button 
                    pButton
                    icon="pi pi-pencil"
                    class="p-button-rounded p-button-text p-button-sm"
                    style="width: 28px; height: 28px; background: #3b82f6; color: white; border-radius: 6px;"
                    (click)="editTag(tag)"
                    pTooltip="Edit"
                    tooltipPosition="top">
                </button>
                <button 
                    pButton
                    icon="pi pi-trash"
                    class="p-button-rounded p-button-text p-button-sm"
                    style="width: 28px; height: 28px; background: #ef4444; color: white; border-radius: 6px;"
                    (click)="deleteTag(tag.id)"
                    pTooltip="Delete"
                    tooltipPosition="top">
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5">
              <div class="d-flex flex-column align-items-center justify-content-center py-8">
                <i class="pi pi-inbox text-gray-400 mb-2" style="font-size: 48px;"></i>
                <div class="text-gray-600 fw-semibold">No tags found</div>
                <div class="text-gray-500" style="font-size: 14px;">No tags match your search criteria.</div>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </ng-container>

    <ng-container *ngIf="(isLoading$ | async) === false && tagsWithIndustries.length === 0">
        <div class="d-flex flex-column align-items-center justify-content-center py-8">
            <i class="pi pi-inbox text-gray-400 mb-2" style="font-size: 48px;"></i>
            <div class="text-gray-600 fw-semibold">No tags available</div>
            <div class="text-gray-500" style="font-size: 14px;">No tags have been created yet.</div>
        </div>
    </ng-container>
  </div>
</div>
</ng-container>
