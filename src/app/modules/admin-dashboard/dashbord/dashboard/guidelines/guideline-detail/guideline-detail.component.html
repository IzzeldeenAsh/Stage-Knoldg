<p-progressBar
  *ngIf="isLoading$ | async"
  mode="indeterminate"
  [style]="{ height: '4px' }"
></p-progressBar>

<div id="kt_app_toolbar" class="app-toolbar pt-10 mb-0">
  <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex align-items-stretch">
    <div class="app-toolbar-wrapper d-flex flex-stack flex-wrap gap-4 w-100">
      <div class="page-title d-flex flex-column justify-content-center gap-1 me-3">
        <h1 class="page-heading d-flex flex-column justify-content-center text-gray-900 fw-bold fs-3 m-0">
          Guideline Detail
          <span *ngIf="guidelineType" class="fs-6 fw-normal text-muted">- {{ guidelineType?.label }}</span>
        </h1>
      </div>

      <!-- Back button and Add New Version button -->
      <div class="d-flex align-items-center gap-3">
        <button type="button" class="btn btn-info btn-sm" (click)="openAddVersionModal()">
          <i class="ki-outline ki-plus fs-3"></i>
          Add New Version
        </button>
        <button type="button" class="btn btn-light-info btn-sm" (click)="navigateBack()">
          <i class="ki-outline ki-arrow-left fs-3"></i>
          Back to Guidelines
        </button>
      </div>
    </div>
  </div>
</div>

<div id="kt_app_content" class="app-content flex-column-fluid">
  <div id="kt_app_content_container" class="app-container container-fluid">
    <div class="card">
      <div class="card-body">
        <div class="d-flex flex-center flex-column py-10">
          <div class="guideline-icon mb-4">
            <svg width="96" height="96" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
              <path d="m453.1 13h-361.717a40.531 40.531 0 0 0 -40.483 40.484v401.886a43.68 43.68 0 0 0 43.629 43.63h358.571a8 8 0 0 0 8-8v-470a8 8 0 0 0 -8-8zm-8 398.739h-322.984v-382.739h322.984zm-353.717-382.739h14.733v382.739h-11.587a43.425 43.425 0 0 0 -27.629 9.892v-368.147a24.513 24.513 0 0 1 24.483-24.484zm3.146 454a27.631 27.631 0 1 1 0-55.261h19.027c.186.013.371.028.56.028s.375-.015.561-.028h330.423v19.631h-342.351a8 8 0 0 0 0 16h342.351v19.63zm89.871-229.084a31.7 31.7 0 0 0 28.1 16.221h142.21a32.448 32.448 0 0 0 28.1-48.679l-71.084-123.158-.009-.016a32.481 32.481 0 0 0 -56.225.016l-35.545 61.594-35.537 61.548a31.654 31.654 0 0 0 -.01 32.474zm13.86-24.458 71.094-123.166a16.48 16.48 0 0 1 28.517 0l35.545 61.595 35.555 61.583a16.448 16.448 0 0 1 -14.255 24.663h-142.216a16.447 16.447 0 0 1 -14.246-24.679zm85.34-23.836a18.129 18.129 0 0 0 17.91-17.507l1.815-35.034a18.68 18.68 0 0 0 -5.243-13.886 19.965 19.965 0 0 0 -28.932-.006 18.694 18.694 0 0 0 -5.25 13.911l1.787 35.015a18.185 18.185 0 0 0 17.913 17.507zm-2.866-55.4a4.031 4.031 0 0 1 2.866-1.239 4.08 4.08 0 0 1 2.9 1.245 2.815 2.815 0 0 1 .848 2.048l-1.817 35.047a2.188 2.188 0 0 1 -1.929 2.3c-1.133 0-1.872-1.188-1.932-2.329l-1.785-34.986a2.832 2.832 0 0 1 .844-2.082zm2.866 56.488a17.936 17.936 0 1 0 17.949 17.922 17.942 17.942 0 0 0 -17.949-17.918zm0 19.871a1.936 1.936 0 1 1 1.949-1.949 1.937 1.937 0 0 1 -1.949 1.953zm103.667 137a8 8 0 0 1 -8 8h-191.311a8 8 0 0 1 0-16h191.306a8 8 0 0 1 8 8.005zm-154.893-24.337a8 8 0 0 1 0-16h102.441a8 8 0 0 1 0 16z" fill="#57a4ff"/>
              <g fill="#9bc9ff">
                <path d="m106.116 411.739v-382.739h-14.733a24.513 24.513 0 0 0 -24.483 24.484v368.147a43.425 43.425 0 0 1 27.631-9.892z"/>
                <path d="m283.6 222.714a1.936 1.936 0 0 0 0 3.871 1.936 1.936 0 1 0 0-3.871z"/>
                <path d="m445.1 29h-322.984v382.739h322.984zm-65.84 342.586h-191.304a8 8 0 0 1 0-16h191.306a8 8 0 0 1 0 16zm-154.886-40.342a8 8 0 0 1 8-8h102.441a8 8 0 0 1 0 16h-102.441a8 8 0 0 1 -8-8zm158.439-77.319a31.689 31.689 0 0 1 -28.1 16.212h-142.213a32.448 32.448 0 0 1 -28.094-48.695l35.537-61.551 35.549-61.591a32.481 32.481 0 0 1 56.225-.016l.009.016 71.09 123.161a31.642 31.642 0 0 1 -.003 32.464z"/>
                <path d="m283.6 148.987a4.031 4.031 0 0 0 -2.866 1.239 2.832 2.832 0 0 0 -.851 2.081l1.785 34.986c.06 1.141.8 2.329 1.932 2.329a2.188 2.188 0 0 0 1.929-2.3l1.817-35.047a2.815 2.815 0 0 0 -.848-2.048 4.08 4.08 0 0 0 -2.898-1.24z"/>
              </g>
            </svg>
          </div>
          <h2 class="text-gray-800 fw-bold mb-4">
            {{ guidelineType?.label || currentValue }}
          </h2>
          <p class="text-muted fs-5 mb-8 text-center">
            This is the detail view for the <strong>{{ currentValue }}</strong> guideline type.<br>
            You can implement the specific content for this guideline here.
          </p>

          <!-- Guideline Content -->
          <div class="w-100">
            <!-- Current Guideline -->
            <div *ngIf="currentGuideline" class="mb-8">
              <div class="d-flex align-items-center mb-4">
                <h5 class="mb-0 me-3">Current Version</h5>
                <span class="badge badge-light-success">Active v{{ currentGuideline.version }}</span>
              </div>

              <div class="card border border-light-success">
                <div class="card-header bg-light-success">
                  <h6 class="card-title mb-0 text-success">{{ currentGuideline.name }}</h6>
                </div>
                <div class="card-body">
                  <div [innerHTML]="currentGuideline.guideline" class="guideline-content"></div>
                </div>
              </div>
            </div>

            <!-- Last Guideline (Upcoming) - Only show if version is different -->
            <div *ngIf="lastGuideline && shouldShowLastGuideline" class="mb-8">
              <div class="d-flex align-items-center mb-4">
                <h5 class="mb-0 me-3">Upcoming Version</h5>
                <span class="badge badge-light-warning">Upcoming v{{ lastGuideline.version }}</span>
              </div>

              <div class="card border border-light-warning">
                <div class="card-header bg-light-warning">
                  <h6 class="card-title mb-0 text-warning">{{ lastGuideline.name }}</h6>
                </div>
                <div class="card-body">
                  <div [innerHTML]="lastGuideline.guideline" class="guideline-content"></div>
                </div>
              </div>
            </div>

            <!-- No Data State -->
            <div *ngIf="!currentGuideline" class="text-center py-10">
              <div class="card border-dashed border-info">
                <div class="card-body text-center py-10">
                  <i class="ki-outline ki-document-outline text-info fs-2x mb-4"></i>
                  <h4 class="text-gray-700 mb-3">No Guideline Found</h4>
                  <p class="text-muted mb-0">
                    No guideline found for <strong>{{ currentValue }}</strong> type.<br>
                    Please check back later or contact your administrator.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add New Version Modal -->
<p-dialog
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="false"
  [showHeader]="true"
  [(visible)]="showAddVersionModal"
  styleClass="add-version-modal"
  [style]="{width: '90vw', maxWidth: '1200px'}"
>
  <ng-template pTemplate="header">
    <span class="fw-bold text-gray-800 fs-3">Add New Version</span>
  </ng-template>

  <!-- Use a SINGLE form group to wrap all controls -->
  <form [formGroup]="addVersionForm">
  <div class="row">
    <!-- English Section -->
    <div class="col-md-6">
      <div class="card border border-light-info mb-4">
        <div class="card-header bg-light-info">
          <h5 class="card-title mb-0 text-info fw-bold">
            <i class="ki-outline ki-global fs-2 me-2"></i>
            English
          </h5>
        </div>
        <div class="card-body">
            <!-- English Name -->
            <div class="mb-4">
              <label class="form-label fw-bold text-gray-700">Name (English)</label>
              <input
                type="text"
                class="form-control"
                formControlName="nameEn"
                placeholder="Enter English name"
              />
            </div>

            <!-- English Guideline Content -->
            <div class="mb-4">
              <label class="form-label fw-bold text-gray-700">Guideline (English)</label>
              <jodit-editor
                [config]="joditConfigEn"
                name="guidelineEn"
                [ngModelOptions]="{ standalone: true }"
                [ngModel]="addVersionForm.get('guidelineEn')?.value"
                (ngModelChange)="onEditorChange($event, 'guidelineEn')"
              ></jodit-editor>
            </div>
        </div>
      </div>
    </div>

    <!-- Arabic Section -->
    <div class="col-md-6">
      <div class="card border border-light-info mb-4">
        <div class="card-header bg-light-info">
          <h5 class="card-title mb-0 text-info fw-bold">
            <i class="ki-outline ki-global fs-2 me-2"></i>
            العربية
          </h5>
        </div>
        <div class="card-body">
            <!-- Arabic Name -->
            <div class="mb-4">
              <label class="form-label fw-bold text-gray-700">الاسم (العربية)</label>
              <input
                type="text"
                class="form-control"
                formControlName="nameAr"
                placeholder="أدخل الاسم بالعربية"
                dir="rtl"
              />
            </div>

            <!-- Arabic Guideline Content -->
            <div class="mb-4">
              <label class="form-label fw-bold text-gray-700">التوجيه (العربية)</label>
              <jodit-editor
                [config]="joditConfigAr"
                name="guidelineAr"
                [ngModelOptions]="{ standalone: true }"
                [ngModel]="addVersionForm.get('guidelineAr')?.value"
                (ngModelChange)="onEditorChange($event, 'guidelineAr')"
              ></jodit-editor>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Shared Fields -->
  <div class="row">
    <div class="col-md-6">
      <div class="mb-4">
        <label class="form-label fw-bold text-gray-700">Version</label>
        <input
          type="text"
          class="form-control"
          formControlName="version"
          placeholder="e.g., 3.8, 3.9"
        />
      </div>
    </div>
    <div class="col-md-6">
      <div class="mb-4">
        <label class="form-label fw-bold text-gray-700">Apply At</label>
        <p-calendar
          formControlName="applyAt"
          [showIcon]="true"
          dateFormat="yy-mm-dd"
          placeholder="Select date"
          styleClass="w-100"
        ></p-calendar>
      </div>
    </div>
  </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="d-flex justify-content-end gap-2">
      <button
        type="button"
        class="btn btn-light"
        (click)="closeAddVersionModal()"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn btn-info"
        (click)="createNewVersion()"
        [disabled]="!addVersionForm.valid || isCreating"
      >
        <span *ngIf="isCreating" class="spinner-border spinner-border-sm me-2"></span>
        Create Version
      </button>
    </div>
  </ng-template>
</p-dialog>
