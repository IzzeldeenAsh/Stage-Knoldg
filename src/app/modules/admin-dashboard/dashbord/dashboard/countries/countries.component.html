<p-progressBar
*ngIf="isLoading$ | async"
mode="indeterminate"
[style]="{ height: '4px' }"
/>

<ng-container *ngIf="!(isLoading$ | async)">
<div id="kt_app_toolbar" class="app-toolbar pt-10 px-10 pb-0 mb-0">
  <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex align-items-stretch">
    <div class="app-toolbar-wrapper d-flex flex-stack flex-wrap gap-4 w-100">
      <div class="page-title d-flex flex-column justify-content-center gap-1 me-3">
        <h1 class="page-heading d-flex flex-column justify-content-center text-gray-900 fw-bold fs-3 m-0">
          Countries
        </h1>
        <div class="fw-semibold fs-7 my-0 text-muted">{{listOfCountries.length}} Countries</div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="d-flex align-items-center position-relative">
          <i class="pi pi-search position-absolute ms-3" style="font-size: 14px; color: #6c757d;"></i>
          <input
              type="text"
              pInputText
              class="form-control ps-10"
              style="width: 240px; height: 36px; border: 1px solid #e1e5e9; border-radius: 6px;"
              placeholder="Search"
              (input)="applyFilter($event)"
          />
        </div>
        <p-dropdown
          appendTo="body"
          id="statusFilter"
          [options]="statusOptions"
          [(ngModel)]="selectedStatus"
          placeholder="Status"
          (onChange)="filterCountries()"
          [style]="{ 'height': '36px', 'min-width': '120px', 'border': '1px solid #e1e5e9', 'border-radius': '6px' }"
        ></p-dropdown>
        <p-dropdown 
          appendTo="body"
          id="regionFilter" 
          [options]="regionOptions" 
          [(ngModel)]="selectedRegionId" 
          placeholder="Region" 
          (onChange)="filterCountriesByRegion()"
          [style]="{ 'height': '36px', 'min-width': '120px', 'border': '1px solid #e1e5e9', 'border-radius': '6px' }"
        ></p-dropdown>
        <button 
          (click)="showDialog()" 
          class="btn btn-sm d-flex align-items-center "
          style="background: white; border: 1px solid #e1e5e9; border-radius: 6px; padding: 6px 12px; height: 36px; white-space: nowrap;"
        >
          <i class="ki-outline ki-plus fs-5" style="color: #3b82f6;"></i>
          <span class="ms-1" style="font-size: 13px; font-weight: 500; color: #374151;">Create</span>
        </button>
      </div>

    
    </div>
  </div>
</div>

<p-dialog appendTo="body" [header]="isEditMode ? 'Edit Country' : 'Add Country'" [modal]="true" [(visible)]="visible" [style]="{ width: '40rem' }">
  <p-messages *ngIf="hasErrorMessage" [(value)]="messages" [enableService]="false"></p-messages>
  <span class="text-muted mb-3 d-block">{{ isEditMode ? 'Edit Country Details' : 'Add Country Details' }}.</span>

  <form [formGroup]="countryForm">
    <!-- Country Name (English) -->
    <div class="mb-3 row">
      <label for="countryEn" class="col-sm-3 col-form-label">Name (English)</label>
      <div class="col-sm-9">
        <input pInputText id="countryEn" class="form-control" formControlName="countryEn" autocomplete="off" />
        <div *ngIf="countryEn && countryEn.errors && (countryEn.touched || countryEn.dirty)">
          <div *ngIf="countryEn.errors['required']" class="text-danger">
            English Name is required.
          </div>
          <div *ngIf="countryEn.errors['serverError']" class="text-danger">
            {{ countryEn.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- Country Name (Arabic) -->
    <div class="mb-3 row">
      <label for="countryAr" class="col-sm-3 col-form-label">Name (Arabic)</label>
      <div class="col-sm-9">
        <input pInputText id="countryAr" class="form-control" formControlName="countryAr" autocomplete="off" />
        <div *ngIf="countryAr && countryAr.errors && (countryAr.touched || countryAr.dirty)">
          <div *ngIf="countryAr.errors['required']" class="text-danger">
            Arabic Name is required.
          </div>
          <div *ngIf="countryAr.errors['serverError']" class="text-danger">
            {{ countryAr.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- Region ID -->
    <div class="mb-3 row">
      <label for="regionId" class="col-sm-3 col-form-label">Region</label>
      <div class="col-sm-9">
        <p-dropdown 
            id="regionId"
            formControlName="regionId"
            [options]="regionOptions"
            placeholder="Select Region"
            appendTo="body">
        </p-dropdown>
        <div *ngIf="regionId && regionId.errors && (regionId.touched || regionId.dirty)">
          <div *ngIf="regionId.errors['required']" class="text-danger">
            Region is required.
          </div>
          <div *ngIf="regionId.errors['serverError']" class="text-danger">
            {{ regionId.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- International Code -->
    <div class="mb-3 row">
      <label for="internationalCode" class="col-sm-3 col-form-label">International Code</label>
      <div class="col-sm-9">
        <input pInputText id="internationalCode" class="form-control" formControlName="internationalCode" autocomplete="off" />
        <div *ngIf="internationalCode && internationalCode.errors && (internationalCode.touched || internationalCode.dirty)">
          <div *ngIf="internationalCode.errors['required']" class="text-danger">
            International Code is required.
          </div>
          <div *ngIf="internationalCode.errors['serverError']" class="text-danger">
            {{ internationalCode.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- ISO2 -->
    <div class="mb-3 row">
      <label for="iso2" class="col-sm-3 col-form-label">ISO2</label>
      <div class="col-sm-9">
        <input pInputText id="iso2" class="form-control" formControlName="iso2" autocomplete="off" />
        <div *ngIf="iso2 && iso2.errors && (iso2.touched || iso2.dirty)">
          <div *ngIf="iso2.errors['required']" class="text-danger">
            ISO2 is required.
          </div>
          <div *ngIf="iso2.errors['serverError']" class="text-danger">
            {{ iso2.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- ISO3 -->
    <div class="mb-3 row">
      <label for="iso3" class="col-sm-3 col-form-label">ISO3</label>
      <div class="col-sm-9">
        <input pInputText id="iso3" class="form-control" formControlName="iso3" autocomplete="off" />
        <div *ngIf="iso3 && iso3.errors && (iso3.touched || iso3.dirty)">
          <div *ngIf="iso3.errors['required']" class="text-danger">
            ISO3 is required.
          </div>
          <div *ngIf="iso3.errors['serverError']" class="text-danger">
            {{ iso3.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- Nationality (English) -->
    <div class="mb-3 row">
      <label for="nationalityEn" class="col-sm-3 col-form-label">Nationality (English)</label>
      <div class="col-sm-9">
        <input pInputText id="nationalityEn" class="form-control" formControlName="nationalityEn" autocomplete="off" />
        <div *ngIf="nationalityEn && nationalityEn.errors && (nationalityEn.touched || nationalityEn.dirty)">
          <div *ngIf="nationalityEn.errors['required']" class="text-danger">
            Nationality (English) is required.
          </div>
          <div *ngIf="nationalityEn.errors['serverError']" class="text-danger">
            {{ nationalityEn.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- Nationality (Arabic) -->
    <div class="mb-3 row">
      <label for="nationalityAr" class="col-sm-3 col-form-label">Nationality (Arabic)</label>
      <div class="col-sm-9">
        <input pInputText id="nationalityAr" class="form-control" formControlName="nationalityAr" autocomplete="off" />
        <div *ngIf="nationalityAr && nationalityAr.errors && (nationalityAr.touched || nationalityAr.dirty)">
          <div *ngIf="nationalityAr.errors['required']" class="text-danger">
            Nationality (Arabic) is required.
          </div>
          <div *ngIf="nationalityAr.errors['serverError']" class="text-danger">
            {{ nationalityAr.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- Status -->
    <div class="mb-3 row">
      <label for="status" class="col-sm-3 col-form-label">Status</label>
      <div class="col-sm-9">
        <p-dropdown 
            id="status" 
            [options]="statusOptions" 
            formControlName="status"
            appendTo="body"
            placeholder="Select Status">
        </p-dropdown>
        <div *ngIf="status && status.errors && (status.touched || status.dirty)">
          <div *ngIf="status.errors['required']" class="text-danger">
            Status is required.
          </div>
          <div *ngIf="status.errors['serverError']" class="text-danger">
            {{ status.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- Flag -->
    <div class="mb-3 row">
      <label for="flag" class="col-sm-3 col-form-label">Flag</label>
      <div class="col-sm-9">
        <input pInputText id="flag" class="form-control" formControlName="flag" autocomplete="off" />
        <div *ngIf="flag && flag.errors && (flag.touched || flag.dirty)">
          <div *ngIf="flag.errors['required']" class="text-danger">
            Flag is required.
          </div>
          <div *ngIf="flag.errors['serverError']" class="text-danger">
            {{ flag.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>
  </form>

  <div class="d-flex justify-content-end gap-2">
    
    <button
    type="submit"
    [disabled]="countryForm.invalid || (isLoading$ | async)" (click)="submit()" class="btn btn-primary btn-sm"
  >
    <ng-container *ngIf="(isLoading$ | async) === false">
      <span class="indicator-label">Save</span>
    </ng-container>
    <ng-container *ngIf="isLoading$ | async">
      <span class="indicator-progress" [style.display]="'block'">
      Please wait
        <span
          class="spinner-border spinner-border-sm align-middle ms-2"
        ></span>
      </span>
    </ng-container>
  </button>
    <button (click)="onCancel()" class="btn btn-outline-secondary btn-sm">
      Cancel
    </button>
  </div>
</p-dialog>

<div id="kt_app_content" class="app-content px-10 pb-10 pt-5 flex-column-fluid">
  <div id="kt_app_content_container" class="app-container container-fluid">
    <p-messages *ngIf="hasSuccessMessage" [(value)]="messages" [enableService]="false"></p-messages>
    
    <ng-container *ngIf="(isLoading$ | async) === false && listOfCountries.length > 0">
      <p-table
        #dt
        [value]="filteredCountries"
        [paginator]="true"
        [rows]="10"
        [loading]="isLoading$ | async"
        [globalFilterFields]="['name', 'names.en', 'names.ar', 'iso2', 'iso3']"
        responsiveLayout="scroll"
        [rowHover]="true"
        [tableStyle]="{'width': '100%'}"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 8%">Flag</th>
            <th style="width: 20%">Name (English)</th>
            <th style="width: 20%">Name (Arabic)</th>
            <th style="width: 10%">ISO2</th>
            <th style="width: 10%">ISO3</th>
            <th style="width: 12%">Status</th>
            <th style="width: 20%"></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-country>
          <tr>
            <td>
              <div class="symbol symbol-20px">
                <span
                  class="symbol-label fw-bold"
                  [inlineSVG]="'./assets/media/flags/' + country.flag + '.svg'"
                ></span>
              </div>
            </td>
            <td>
              <span class="text-gray-800 fw-semibold">{{ country.names.en }}</span>
            </td>
            <td>
              <span class="text-gray-700">{{ country.names.ar }}</span>
            </td>
            <td>
              <span class="text-gray-600">{{ country.iso2 }}</span>
            </td>
            <td>
              <span class="text-gray-600">{{ country.iso3 }}</span>
            </td>
            <td>
              <span class="px-3 py-1 rounded fw-semibold" style="font-size: 12px;" [ngStyle]="{
                  'background-color': country.status === 'active' ? '#d1eddb' : '#f8d7da',
                  'color': country.status === 'active' ? '#155724' : '#721c24'
              }">
                  {{ country.status }}
              </span>
            </td>
            <td>
              <div class="d-flex justify-content-end gap-1">
                <button 
                    pButton
                    icon="pi pi-pencil"
                    class="p-button-rounded p-button-text p-button-sm"
                    style="width: 28px; height: 28px; background: #3b82f6; color: white; border-radius: 6px;"
                    (click)="editCountry(country)"
                    pTooltip="Edit"
                    tooltipPosition="top">
                </button>
                <button 
                    pButton
                    icon="pi pi-trash"
                    class="p-button-rounded p-button-text p-button-sm"
                    style="width: 28px; height: 28px; background: #ef4444; color: white; border-radius: 6px;"
                    (click)="deleteCountry(country.id)"
                    pTooltip="Delete"
                    tooltipPosition="top">
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7">
              <div class="d-flex flex-column align-items-center justify-content-center py-8">
                <i class="pi pi-inbox text-gray-400 mb-2" style="font-size: 48px;"></i>
                <div class="text-gray-600 fw-semibold">No countries found</div>
                <div class="text-gray-500" style="font-size: 14px;">No countries match your search criteria.</div>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </ng-container>

    <ng-container *ngIf="(isLoading$ | async) === false && listOfCountries.length === 0">
        <div class="d-flex flex-column align-items-center justify-content-center py-8">
            <i class="pi pi-inbox text-gray-400 mb-2" style="font-size: 48px;"></i>
            <div class="text-gray-600 fw-semibold">No countries available</div>
            <div class="text-gray-500" style="font-size: 14px;">No countries have been created yet.</div>
        </div>
    </ng-container>
  </div>
</div>
</ng-container>