<p-progressBar
*ngIf="isLoading$ | async"
mode="indeterminate"
[style]="{ height: '4px' }"
/>

<ng-container *ngIf="!(isLoading$ | async)">
<div id="kt_app_toolbar" class="app-toolbar pt-10 px-10 pb-0 mb-0">
  <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex align-items-stretch">
    <div class="app-toolbar-wrapper d-flex flex-stack flex-wrap gap-4 w-100">
      <div class="page-title d-flex flex-column justify-content-center gap-1 me-3">
        <h1 class="page-heading d-flex flex-column justify-content-center text-gray-900 fw-bold fs-3 m-0">
          Topics
        </h1>
        <div class="fw-semibold fs-7 my-0 text-muted">{{paginatedTopics.meta.total || 0}} Topics</div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="d-flex align-items-center position-relative">
          <i class="pi pi-search position-absolute ms-3" style="font-size: 14px; color: #6c757d;"></i>
          <input
              type="text"
              pInputText
              class="form-control ps-10"
              style="width: 240px; height: 36px; border: 1px solid #cbd5e1; border-radius: 6px;"
              placeholder="Search"
              (input)="applyFilter($event)"
          />
        </div>
        <p-dropdown
          appendTo="body"
          id="statusFilter"
          [(ngModel)]="selectedStatus"
          [options]="[
            { label: 'All Status', value: '' },
            { label: 'Active', value: 'active' },
            { label: 'Inactive', value: 'inactive' },
            { label: 'Suggestion', value: 'suggestion' }
          ]"
          optionLabel="label"
          optionValue="value"
          placeholder="Status"
          (onChange)="applyStatusFilter()"
          [style]="{ 'height': '36px', 'min-width': '120px', 'border': '1px solid #cbd5e1', 'border-radius': '6px' }"
        ></p-dropdown>
        <button 
          (click)="showDialog()" 
          class="btn btn-sm d-flex align-items-center "
          style="background: white; border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px 12px; height: 36px; white-space: nowrap;"
        >
          <i class="ki-outline ki-plus fs-5" style="color: #3b82f6;"></i>
          <span class="ms-1" style="font-size: 13px; font-weight: 500; color: #374151;">Create</span>
        </button>
      </div>

    
    </div>
  </div>
</div>

<p-dialog appendTo="body" [header]="isUpdate ? 'Edit Topic' : 'Add Topic'" [modal]="true" [(visible)]="displayDialog" [style]="{ width: '40rem' }" (onHide)="onCancel()">
  <p-messages *ngIf="messages && messages.length > 0" [(value)]="messages" [enableService]="false"></p-messages>
  <span class="text-muted mb-3 d-block">{{ isUpdate ? 'Edit Topic Details' : 'Add Topic Details' }}.</span>

  <form [formGroup]="topicForm">
    <!-- Topic Name (English) -->
    <div class="mb-3 row">
      <label for="nameEn" class="col-sm-3 col-form-label">Name (English)</label>
      <div class="col-sm-9">
        <input pInputText id="nameEn" class="form-control" formControlName="nameEn" autocomplete="off" />
        <div *ngIf="nameEn && nameEn.errors && (nameEn.touched || nameEn.dirty)">
          <div *ngIf="nameEn.errors['required']" class="text-danger">
            English Name is required.
          </div>
          <div *ngIf="nameEn.errors['serverError']" class="text-danger">
            {{ nameEn.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- Topic Name (Arabic) -->
    <div class="mb-3 row">
      <label for="nameAr" class="col-sm-3 col-form-label">Name (Arabic)</label>
      <div class="col-sm-9">
        <input pInputText id="nameAr" class="form-control" formControlName="nameAr" autocomplete="off" />
        <div *ngIf="nameAr && nameAr.errors && (nameAr.touched || nameAr.dirty)">
          <div *ngIf="nameAr.errors['required']" class="text-danger">
            Arabic Name is required.
          </div>
          <div *ngIf="nameAr.errors['serverError']" class="text-danger">
            {{ nameAr.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- Industry -->
    <div class="mb-3 row">
      <label for="industryId" class="col-sm-3 col-form-label">Industry</label>
      <div class="col-sm-9">
        <p-treeSelect
          appendTo="body"
          formControlName="industryId"
          [options]="industries"
          selectionMode="single"
          placeholder="Select Industry"
          [filter]="true"
          [showClear]="true"
          class="w-100"
          optionLabel="label"
          styleClass="w-100"
        ></p-treeSelect>
        <div *ngIf="industryId && industryId.errors && (industryId.touched || industryId.dirty)">
          <div *ngIf="industryId.errors['required']" class="text-danger">
            Industry is required.
          </div>
          <div *ngIf="industryId.errors['serverError']" class="text-danger">
            {{ industryId.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- Status -->
    <div class="mb-3 row">
      <label for="status" class="col-sm-3 col-form-label">Status</label>
      <div class="col-sm-9">
        <p-dropdown 
            id="status" 
            [options]="[
              { label: 'Active', value: 'active' },
              { label: 'Inactive', value: 'inactive' },
              { label: 'Suggestion', value: 'suggestion' }
            ]"
            optionLabel="label"
            optionValue="value"
            formControlName="status"
            appendTo="body"
            placeholder="Select Status">
        </p-dropdown>
        <div *ngIf="status && status.errors && (status.touched || status.dirty)">
          <div *ngIf="status.errors['required']" class="text-danger">
            Status is required.
          </div>
          <div *ngIf="status.errors['serverError']" class="text-danger">
            {{ status.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- Keywords English -->
    <div class="mb-3 row">
      <label for="keywordsEn" class="col-sm-3 col-form-label">Keywords (English)</label>
      <div class="col-sm-9">
        <tag-input
          formControlName="keywordsEn"
          [secondaryPlaceholder]="'Enter keywords in English'"
          [separatorKeyCodes]="[188, 13, 1548]"
          [addOnBlur]="true"
          [placeholder]="'Enter keywords in English'"
          [displayBy]="'display'"
          [identifyBy]="'value'"
          [modelAsStrings]="false"
        >
          <tag-input-dropdown
            [showDropdownIfEmpty]="true"
            [autocompleteItems]="availableEnglishKeywords"
          ></tag-input-dropdown>
        </tag-input>
        <div class="form-text">Enter keywords separated by commas</div>
        <div *ngIf="keywordsEn && keywordsEn.errors && (keywordsEn.touched || keywordsEn.dirty)">
          <div *ngIf="keywordsEn.errors['serverError']" class="text-danger">
            {{ keywordsEn.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>

    <!-- Keywords Arabic -->
    <div class="mb-3 row">
      <label for="keywordsAr" class="col-sm-3 col-form-label">Keywords (Arabic)</label>
      <div class="col-sm-9">
        <tag-input
          formControlName="keywordsAr"
          [secondaryPlaceholder]="'Enter keywords in Arabic'"
          [separatorKeyCodes]="[188, 13, 1548]"
          [addOnBlur]="true"
          [placeholder]="'Enter keywords in Arabic'"
          [displayBy]="'display'"
          [identifyBy]="'value'"
          [modelAsStrings]="false"
        >
          <tag-input-dropdown
            [showDropdownIfEmpty]="true"
            [autocompleteItems]="availableArabicKeywords"
          ></tag-input-dropdown>
        </tag-input>
        <div class="form-text">Enter keywords separated by commas</div>
        <div *ngIf="keywordsAr && keywordsAr.errors && (keywordsAr.touched || keywordsAr.dirty)">
          <div *ngIf="keywordsAr.errors['serverError']" class="text-danger">
            {{ keywordsAr.errors['serverError'] }}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Form-level validation errors -->
    <div *ngIf="topicForm.errors && (topicForm.touched || topicForm.dirty)" class="alert alert-danger">
      <div *ngIf="topicForm.errors['keywordsMismatch']" class="d-flex align-items-center">
        <i class="ki-duotone ki-cross-circle fs-2 me-2"></i>
        <span>The number of keywords in English and Arabic must match</span>
      </div>
    </div>
  </form>

  <div class="d-flex justify-content-end gap-2">
    
    <button
    type="submit"
    [disabled]="topicForm.invalid || (isLoading$ | async)" (click)="submit()" class="btn btn-primary btn-sm"
  >
    <ng-container *ngIf="(isLoading$ | async) === false">
      <span class="indicator-label">{{ isUpdate ? 'Update' : 'Save' }}</span>
    </ng-container>
    <ng-container *ngIf="isLoading$ | async">
      <span class="indicator-progress" [style.display]="'block'">
      Please wait
        <span
          class="spinner-border spinner-border-sm align-middle ms-2"
        ></span>
      </span>
    </ng-container>
  </button>
    <button (click)="onCancel()" class="btn btn-outline-secondary btn-sm">
      Cancel
    </button>
  </div>
</p-dialog>

<div id="kt_app_content" class="app-content px-10 pb-10 pt-5 flex-column-fluid">
  <div id="kt_app_content_container" class="app-container container-fluid">
    
    <ng-container *ngIf="(isLoading$ | async) === false && topics.length > 0">
      <p-table
        #dt
        [value]="topics"
        [paginator]="true"
        [rows]="10"
        [loading]="isLoading$ | async"
        [globalFilterFields]="['names.en', 'names.ar', 'status']"
        responsiveLayout="scroll"
        [rowHover]="true"
        [tableStyle]="{'width': '100%'}"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 8%">ID</th>
            <th style="width: 20%">Name (English)</th>
            <th style="width: 20%">Name (Arabic)</th>
            <th style="width: 20%">Industry</th>
            <th style="width: 12%">Status</th>
            <th style="width: 20%"></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-topic>
          <tr>
            <td>
              <span class="text-gray-600">{{ topic.id }}</span>
            </td>
            <td>
              <span class="text-gray-800 fw-semibold">{{ topic.names.en }}</span>
            </td>
            <td>
              <span class="text-gray-700">{{ topic.names.ar }}</span>
            </td>
            <td>
              <span class="text-gray-600">{{ getIndustryName(topic.industry_id) }}</span>
            </td>
            <td>
              <span class="px-3 py-1 rounded fw-semibold" style="font-size: 12px;" [ngStyle]="{
                  'background-color': topic.status === 'active' ? '#d1eddb' : topic.status === 'inactive' ? '#f8d7da' : '#fff3cd',
                  'color': topic.status === 'active' ? '#155724' : topic.status === 'inactive' ? '#721c24' : '#856404'
              }">
                  {{ topic.status }}
              </span>
            </td>
            <td>
              <div class="d-flex justify-content-end gap-1">
                <button 
                    pButton
                    icon="pi pi-pencil"
                    class="p-button-rounded p-button-text p-button-sm"
                    style="width: 28px; height: 28px; background: #3b82f6; color: white; border-radius: 6px;"
                    (click)="editTopic(topic)"
                    pTooltip="Edit"
                    tooltipPosition="top">
                </button>
                <button 
                    pButton
                    icon="pi pi-trash"
                    class="p-button-rounded p-button-text p-button-sm"
                    style="width: 28px; height: 28px; background: #ef4444; color: white; border-radius: 6px;"
                    (click)="deleteTopic(topic)"
                    pTooltip="Delete"
                    tooltipPosition="top">
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6">
              <div class="d-flex flex-column align-items-center justify-content-center py-8">
                <i class="pi pi-inbox text-gray-400 mb-2" style="font-size: 48px;"></i>
                <div class="text-gray-600 fw-semibold">No topics found</div>
                <div class="text-gray-500" style="font-size: 14px;">No topics match your search criteria.</div>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </ng-container>

    <ng-container *ngIf="(isLoading$ | async) === false && topics.length === 0">
        <div class="d-flex flex-column align-items-center justify-content-center py-8">
            <i class="pi pi-inbox text-gray-400 mb-2" style="font-size: 48px;"></i>
            <div class="text-gray-600 fw-semibold">No topics available</div>
            <div class="text-gray-500" style="font-size: 14px;">No topics have been created yet.</div>
        </div>
    </ng-container>
  </div>
</div>
</ng-container>