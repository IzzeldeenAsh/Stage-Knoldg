<p-progressBar
  *ngIf="isLoading$ | async"
  mode="indeterminate"
  [style]="{ height: '3px' }"
></p-progressBar>

<div class="users-page p-10">


  <p-tabView [(activeIndex)]="activeTab" (onChange)="onTabChange($event.index)">
    <p-tabPanel header="Clients">
      <div class="tab-header">
        <div>
          <h2 class="tab-title">Clients</h2>
          <p class="tab-summary">{{ totalClients }} client accounts</p>
        </div>
        <div class="tab-actions">
          <input
            type="text"
            class="form-control form-control-solid"
            placeholder="Search clients"
            [(ngModel)]="searchValue"
            (input)="applyFilter(searchValue, 'clients')"
          />
        </div>
      </div>

      <p-table
        #clientsTable
        [value]="clients"
        dataKey="id"
        [globalFilterFields]="['name', 'email', 'country']"
        [responsiveLayout]="'scroll'"
        class="users-table"
        emptyMessage="No clients found"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Country</th>
            <th>Status</th>
            <th>Verified</th>
            <th class="action-col">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-client>
          <tr>
            <td>
              <div class="cell-main">{{ client.name || '-' }}</div>
              <div class="cell-sub" *ngIf="client.roles?.length">{{ client.roles.join(', ') }}</div>
            </td>
            <td>{{ client.email }}</td>
            <td>{{ client.country || '-' }}</td>
            <td>
              <span class="status" [class.status-active]="client.status === 'active'" [class.status-inactive]="client.status !== 'active'">
                {{ client.status || 'unknown' }}
              </span>
            </td>
            <td>
              <span class="status" [class.status-active]="client.verified" [class.status-inactive]="!client.verified">
                {{ client.verified ? 'Verified' : 'Not verified' }}
              </span>
            </td>
            <td class="action-col">
              <button type="button" class="btn btn-sm btn-light-danger" (click)="deactivateClient(client)">
                Deactivate & Delete
              </button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-tabPanel>

    <p-tabPanel header="Insighters">
      <div class="tab-header">
        <div>
          <h2 class="tab-title">Insighters</h2>
          <p class="tab-summary">{{ totalInsighters }} insighter accounts</p>
        </div>
        <div class="tab-actions">
          <input
            type="text"
            class="form-control form-control-solid"
            placeholder="Search insighters"
            [(ngModel)]="searchValue"
            (input)="applyFilter(searchValue, 'insighters')"
          />
        </div>
      </div>

      <p-table
        #insightersTable
        [value]="insighters"
        dataKey="id"
        [globalFilterFields]="['name', 'email', 'country']"
        [responsiveLayout]="'scroll'"
        class="users-table"
        emptyMessage="No insighters found"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Country</th>
            <th>Industries</th>
            <th>Status</th>
            <th class="action-col">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-insighter>
          <tr>
            <td>
              <div class="cell-main">{{ insighter.name || '-' }}</div>
              <div class="cell-sub">{{ insighter.roles?.join(', ') || 'insighter' }}</div>
            </td>
            <td>{{ insighter.email }}</td>
            <td>{{ insighter.country || '-' }}</td>
            <td>
              <span class="cell-multi">
                {{ formatNames(insighter.industries) }}
              </span>
            </td>
            <td>
              <div class="status-stack">
                <span class="status" [class.status-active]="insighter.client_status === 'active'" [class.status-inactive]="insighter.client_status !== 'active'">
                  Client: {{ insighter.client_status || 'unknown' }}
                </span>
                <span class="status" [class.status-active]="insighter.insighter_status === 'active'" [class.status-inactive]="insighter.insighter_status !== 'active'">
                  Insighter: {{ insighter.insighter_status || 'unknown' }}
                </span>
              </div>
            </td>
            <td class="action-col action-stack">
              <button
                type="button"
                class="btn btn-sm btn-light-primary"
                (click)="handleInsighterAction(insighter, 'activate')"
                [disabled]="insighter.insighter_status === 'active'"
              >
                Activate
              </button>
              <button
                type="button"
                class="btn btn-sm btn-light-warning"
                (click)="handleInsighterAction(insighter, 'deactivate')"
                [disabled]="insighter.insighter_status === 'inactive'"
              >
                Deactivate
              </button>
              <button
                type="button"
                class="btn btn-sm btn-light-danger"
                (click)="handleInsighterAction(insighter, 'deactivate-delete')"
              >
                Deactivate & Delete
              </button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-tabPanel>

    <p-tabPanel header="Company">
      <div class="tab-header">
        <div>
          <h2 class="tab-title">Company</h2>
          <p class="tab-summary">{{ totalCompanies }} company accounts</p>
        </div>
        <div class="tab-actions">
          <input
            type="text"
            class="form-control form-control-solid"
            placeholder="Search companies"
            [(ngModel)]="searchValue"
            (input)="applyFilter(searchValue, 'companies')"
          />
        </div>
      </div>

      <p-table
        #companiesTable
        [value]="companies"
        dataKey="id"
        [globalFilterFields]="['name', 'email', 'country']"
        [responsiveLayout]="'scroll'"
        class="users-table"
        emptyMessage="No companies found"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Contact</th>
            <th>Email</th>
            <th>Company</th>
            <th>Status</th>
            <th>Country</th>
            <th class="action-col">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-company>
          <tr>
            <td>
              <div class="cell-main">{{ company.name || '-' }}</div>
              <div class="cell-sub">{{ company.roles?.join(', ') || 'company' }}</div>
            </td>
            <td>{{ company.email }}</td>
            <td>
              <div class="cell-main">{{ company.company?.legal_name || '-' }}</div>
              <div class="cell-sub" *ngIf="company.company?.website">{{ company.company?.website }}</div>
            </td>
            <td>
              <div class="status-stack">
                <span class="status" [class.status-active]="company.company?.status === 'active'" [class.status-inactive]="company.company?.status !== 'active'">
                  Company: {{ company.company?.status || 'unknown' }}
                </span>
                <span class="status" [class.status-active]="company.company?.verified" [class.status-inactive]="!company.company?.verified">
                  Verified: {{ company.company?.verified ? 'Yes' : 'No' }}
                </span>
              </div>
            </td>
            <td>{{ company.country || '-' }}</td>
            <td class="action-col action-stack">
              <button
                type="button"
                class="btn btn-sm btn-light-primary"
                (click)="handleCompanyAction(company, 'activate')"
                [disabled]="company.company?.status === 'active'"
              >
                Activate
              </button>
              <button
                type="button"
                class="btn btn-sm btn-light-warning"
                (click)="handleCompanyAction(company, 'deactivate')"
                [disabled]="company.company?.status === 'inactive'"
              >
                Deactivate
              </button>
              <button
                type="button"
                class="btn btn-sm btn-light-danger"
                (click)="handleCompanyAction(company, 'deactivate-delete')"
              >
                Deactivate & Delete
              </button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-tabPanel>
  </p-tabView>
</div>
