<!-- Chart Section -->
<div class="card mb-5 light-wallet-gradient-bg">
  <div class="card-header border-0 pt-5">
    <div class="d-flex  w-100">
      <div class="d-flex align-items-center">
        <i class="ki-outline ki-dollar text-gray-700 fs-2tx me-4"></i>
        <div class="flex-grow-1">
          <div class="d-flex align-items-center justify-content-between gap-5">
            <span class="fw-bold fs-3x lh-1 ls-n2 " style="color:#4f28ed; padding-top: 20px;" *ngIf="!balanceLoading">${{ platformBalance.toFixed(2) }}</span>
            <div *ngIf="balanceLoading" class="d-flex align-items-center">
              <div class="spinner-border spinner-border-sm text-info me-2"></div>
              <span class="text-muted">{{ lang === 'ar' ? 'جارٍ التحميل...' : 'Loading...' }}</span>
            </div>
          </div>
          <div class="m-0">
            <span class="fw-semibold fs-6 text-gray-500">{{ lang === 'ar' ? 'رصيد المنصة الحالي' : 'Current Platform Balance' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card-body" >
    <!-- Chart Container -->
    <div class="chart-container " *ngIf="hasRealData">
      <p-chart type="line"
               [data]="chartData"
               [options]="chartOptions"
               class="wallet-chart"
               *ngIf="chartData">
      </p-chart>
    </div>

  </div>
</div>

<!-- Transactions Table -->
<div class="card">
  <div class="card-header border-0 pt-5">
    <div class="d-flex justify-content-between align-items-center w-100">
      <h3 class="card-title align-items-start flex-column">
        <span class="card-label fw-bold fs-3 mb-1">{{ lang === 'ar' ? 'سجل المعاملات' : 'Transactions History' }}</span>
        <span class="text-muted fw-semibold fs-7">{{ lang === 'ar' ? 'تتبع الأموال الواردة والصادرة من هذه المنطقة.' : 'Track money coming in and going out from this area.' }}</span>
      </h3>

      <!-- Period Selection Buttons -->
      <div class="d-flex align-items-center p-1" style="background-color: #F1F5F9; border-radius: 6px; gap: 2px;">
        <button
          *ngFor="let option of periodOptions"
          type="button"
          class="btn btn-sm px-2 py-1 border-0"
          [ngClass]="{
            'bg-white text-dark fw-semibold shadow-sm': selectedPeriod === option.value,
            'bg-transparent text-muted': selectedPeriod !== option.value
          }"
          (click)="setPeriod(option.value)"
          style="border-radius: 6px; font-size: 12px; min-width: 55px; transition: all 0.2s ease;">
          {{ lang === 'ar' ? option.labelAr : option.label }}
        </button>
      </div>
    </div>
  </div>

  <div class="card-body py-3" style="margin-top: 20px;">
    <p-table
      [value]="transactions"
      [loading]="loading"
      [paginator]="false"
      styleClass="p-datatable-gridlines"
      responsiveLayout="stack"
      [breakpoint]="'768px'">

      <ng-template pTemplate="header">
        <tr>
          <th style="width: 15%;" [style.text-align]="lang === 'ar' ? 'right' : 'left'">{{ lang === 'ar' ? 'الخدمة' : 'Service' }}</th>
          <th style="width: 15%;" [style.text-align]="lang === 'ar' ? 'right' : 'left'">{{ lang === 'ar' ? 'رقم الطلب' : 'Order' }}</th>
          <th style="width: 12%;" [style.text-align]="lang === 'ar' ? 'right' : 'left'">{{ lang === 'ar' ? 'التاريخ' : 'Date' }}</th>
          <th style="width: 13%;" [style.text-align]="lang === 'ar' ? 'right' : 'left'">{{ lang === 'ar' ? 'المعاملة' : 'Transaction' }}</th>
          <th style="width: 13%;" [style.text-align]="lang === 'ar' ? 'right' : 'left'">{{ lang === 'ar' ? 'النوع' : 'Type' }}</th>
          <th style="width: 12%;" [style.text-align]="lang === 'ar' ? 'right' : 'left'">{{ lang === 'ar' ? 'المبلغ' : 'Amount' }}</th>
          <th style="width: 20%; text-align: center;">{{ lang === 'ar' ? 'التفاصيل' : 'Details' }}</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-transaction>
        <tr>
          <!-- Service Column -->
          <td [attr.data-label]="lang === 'ar' ? 'الخدمة' : 'Service'" [style.text-align]="lang === 'ar' ? 'right' : 'left'">
            <span class="fw-semibold">{{ formatService(transaction.type) }}</span>
          </td>

          <!-- Order Column -->
          <td [attr.data-label]="lang === 'ar' ? 'رقم الطلب' : 'Order'" [style.text-align]="lang === 'ar' ? 'right' : 'left'">
            <span class="text-info fw-semibold" *ngIf="transaction.order?.order_no; else noOrder">
              #{{ transaction.order.order_no }}
            </span>
            <ng-template #noOrder>
              <span class="text-muted">{{ lang === 'ar' ? 'غير متاح' : 'N/A' }}</span>
            </ng-template>
          </td>

          <!-- Date Column -->
          <td [attr.data-label]="lang === 'ar' ? 'التاريخ' : 'Date'" [style.text-align]="lang === 'ar' ? 'right' : 'left'">
            <span class="text-muted">{{ formatDate(transaction.date) }}</span>
          </td>

          <!-- Transaction Type Column (Deposit/Withdraw) -->
          <td [attr.data-label]="lang === 'ar' ? 'المعاملة' : 'Transaction'" [style.text-align]="lang === 'ar' ? 'right' : 'left'">
            <span class="badge fs-base" [ngClass]="transaction.transaction === 'deposit' ? 'badge-light-success' : 'badge-light-danger'">
              <i class="pi" [ngClass]="{
                'pi-arrow-up text-success': transaction.transaction === 'deposit',
                'pi-arrow-down text-danger': transaction.transaction !== 'deposit',
                'me-1': lang !== 'ar',
                'ms-1': lang === 'ar'
              }"></i>
              {{ getTransactionType(transaction) }}
            </span>
          </td>

          <!-- Operation Type Column -->
          <td [attr.data-label]="lang === 'ar' ? 'النوع' : 'Type'" [style.text-align]="lang === 'ar' ? 'right' : 'left'">
            <span class="badge badge-light-info fs-base">
              {{ transaction.type | titlecase }}
            </span>
          </td>

          <!-- Amount Column -->
          <td [attr.data-label]="lang === 'ar' ? 'المبلغ' : 'Amount'" [style.text-align]="lang === 'ar' ? 'right' : 'left'">
            <span
              [class]="'badge ' + (transaction.transaction === 'deposit' ? 'badge-light-success' : 'badge-light-danger') + ' fs-base px-2 py-1'">
            {{ formatAmount(transaction.amount) }}
            </span>
          </td>

          <!-- Details Column -->
          <td [attr.data-label]="lang === 'ar' ? 'التفاصيل' : 'Details'" class="text-center">
            <button
              type="button"
              class="btn btn-sm btn-icon btn-light-primary"
              (click)="showTransactionDetails(transaction)"
              [title]="lang === 'ar' ? 'عرض التفاصيل' : 'View Details'">
              <i class="ki-outline ki-eye fs-4"></i>
            </button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center py-5">
            <span class="text-muted">{{ lang === 'ar' ? 'لا توجد معاملات' : 'No transactions found' }}</span>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-4" *ngIf="totalRecords > pageSize">
      <div class="text-muted">
        {{ lang === 'ar' ? 'عرض الصفحة' : 'Showing page' }} {{ currentPage }} {{ lang === 'ar' ? 'من' : 'of' }} {{ Math.ceil(totalRecords / pageSize) }} {{ lang === 'ar' ? 'صفحات' : 'pages' }}
      </div>
      <p-paginator
        [rows]="pageSize"
        [totalRecords]="totalRecords"
        [first]="(currentPage - 1) * pageSize"
        (onPageChange)="onPageChange($event)"
        styleClass="p-paginator-sm">
      </p-paginator>
    </div>
  </div>
</div>

<!-- Transaction Details Dialog -->
<p-dialog [(visible)]="displayDialog"
  [modal]="true"
  [style]="{width: '90vw', maxWidth: '1200px'}"
  [maximizable]="true"
  [header]="'Transaction Details'"
  [draggable]="false"
  [resizable]="false"
  styleClass="transaction-details-dialog">

  <div *ngIf="selectedTransaction" class="transaction-details">
    <!-- Header Section with Key Information -->
    <div class="detail-header">
      <div class="header-grid">
        <div class="header-item">
          <div class="header-content">
            <span class="header-label">Transaction Type</span>
            <span class="badge" [ngClass]="getTransactionBadgeClass(selectedTransaction.transaction)">{{ selectedTransaction.transaction | titlecase }}</span>
          </div>
        </div>
        <div class="header-item">
          <i class="pi pi-dollar header-icon"></i>
          <div class="header-content">
            <span class="header-label">Amount</span>
            <span class="header-value amount" [class.text-success]="selectedTransaction.amount > 0" [class.text-danger]="selectedTransaction.amount < 0">
              {{ selectedTransaction.amount > 0 ? '+' : '' }}{{ formatCurrency(selectedTransaction.amount) }}
            </span>
          </div>
        </div>
        <div class="header-item">
          <i class="pi pi-calendar header-icon"></i>
          <div class="header-content">
            <span class="header-label">Date</span>
            <span class="header-value">{{ formatDate(selectedTransaction.date) }}</span>
          </div>
        </div>
        <div class="header-item">
          <i class="pi pi-tag header-icon"></i>
          <div class="header-content">
            <span class="header-label">Category</span>
            <span class="badge badge-light-info">{{ getTransactionTypeLabel(selectedTransaction.type) | titlecase }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Insighter Information Section -->
    <div class="insighter-section" *ngIf="selectedTransaction.insighter && shouldShowInsighterInfo(selectedTransaction.type)">
      <h3 class="section-title">
        <i class="pi pi-user"></i>
        Insighter Information
      </h3>

      <div class="insighter-card enhanced-card profile-card-modern">
        <!-- Main Profile Header -->
        <div class="profile-header-modern">
          <div class="profile-avatar-modern">
            <img *ngIf="selectedTransaction.insighter.profile_photo_url"
                 [src]="selectedTransaction.insighter.profile_photo_url"
                 [alt]="selectedTransaction.insighter.name">
            <div *ngIf="!selectedTransaction.insighter.profile_photo_url"
                 class="avatar-placeholder">
              {{ selectedTransaction.insighter.name.charAt(0) }}
            </div>
          </div>
          <div class="profile-info-modern">
            <h4 class="profile-name-modern">{{ selectedTransaction.insighter.name }}</h4>
            <div class="profile-roles-modern">
              <span class="role-badge" *ngFor="let role of selectedTransaction.insighter.roles">{{ role }}</span>
            </div>
          </div>
        </div>

        <!-- Company Information if available -->
        <div class="company-section" *ngIf="selectedTransaction.insighter.company">
          <div class="company-card-modern">
            <div class="company-header-modern">
              <img *ngIf="selectedTransaction.insighter.company.logo"
                   [src]="selectedTransaction.insighter.company.logo"
                   [alt]="selectedTransaction.insighter.company.legal_name"
                   class="company-logo-modern">
              <div class="company-info-modern">
                <h5 class="company-name-modern">{{ selectedTransaction.insighter.company.legal_name }}</h5>
                <div class="company-status">
                  <span class="verification-badge" [ngClass]="selectedTransaction.insighter.company.verified ? 'verified' : 'unverified'">
                    {{ selectedTransaction.insighter.company.verified ? 'Verified' : 'Unverified' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- User (Buyer) Information Section -->
    <div class="user-section" *ngIf="selectedTransaction.order && selectedTransaction.order.user">
      <h3 class="section-title">
        <i class="pi pi-shopping-cart"></i>
        Customer Information
      </h3>

      <div class="user-card enhanced-card profile-card-modern">
        <div class="profile-header-modern">
          <div class="profile-avatar-modern">
            <img *ngIf="selectedTransaction.order.user.profile_photo_url"
                 [src]="selectedTransaction.order.user.profile_photo_url"
                 [alt]="selectedTransaction.order.user.name">
            <div *ngIf="!selectedTransaction.order.user.profile_photo_url"
                 class="avatar-placeholder">
              {{ selectedTransaction.order.user.name.charAt(0) }}
            </div>
          </div>
          <div class="profile-info-modern">
            <h4 class="profile-name-modern">{{ selectedTransaction.order.user.name }}</h4>
            <p class="profile-email-modern">{{ selectedTransaction.order.user.email }}</p>
            <div class="profile-roles-modern">
              <span class="role-badge" *ngFor="let role of selectedTransaction.order.user.roles">{{ role }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Information Section -->
    <div class="items-section" *ngIf="selectedTransaction.order && selectedTransaction.order.orderable">
      <h3 class="section-title">
        <i class="pi pi-file-text"></i>
        Order Details
      </h3>

      <!-- Order Metadata -->
      <div class="order-metadata">
        <div class="metadata-grid-modern">
          <div class="metadata-item-modern">
            <span class="metadata-label-modern">Order Number</span>
            <span class="metadata-value-modern">{{ selectedTransaction.order.order_no }}</span>
          </div>
          <div class="metadata-item-modern">
            <span class="metadata-label-modern">Invoice Number</span>
            <span class="metadata-value-modern">{{ selectedTransaction.order.invoice_no }}</span>
          </div>
          <div class="metadata-item-modern">
            <span class="metadata-label-modern">Service Type</span>
            <span class="modern-badge primary">{{ selectedTransaction.order.service | titlecase }}</span>
          </div>
          <div class="metadata-item-modern">
            <span class="metadata-label-modern">Order Status</span>
            <span class="modern-badge" [ngClass]="selectedTransaction.order.status === 'paid' ? 'success' : 'warning'">
              {{ selectedTransaction.order.status | titlecase }}
            </span>
          </div>
          <div class="metadata-item-modern">
            <span class="metadata-label-modern">Order Date</span>
            <span class="metadata-value-modern">{{ formatDate(selectedTransaction.order.date) }}</span>
          </div>
        </div>
      </div>

      <div class="orderables-container">
        <div class="orderable-card">
          <div class="orderable-header">
            <span class="orderable-number">Order Contents</span>
          </div>

          <!-- Knowledge Items -->
          <div class="knowledge-section" *ngIf="selectedTransaction.order.orderable.knowledge && selectedTransaction.order.orderable.knowledge.length > 0">
            <h4 class="subsection-title">Knowledge Products</h4>
            <div class="knowledge-items">
              <div class="knowledge-item" *ngFor="let item of selectedTransaction.order.orderable.knowledge">
                <div class="knowledge-type">
                  <p-chip [label]="item.type" styleClass="custom-chip"></p-chip>
                </div>
                <div class="knowledge-title">{{ item.title }}</div>
              </div>
            </div>
          </div>

          <!-- Documents -->

          <div class="documents-section" *ngIf="selectedTransaction.order.orderable?.knowledge_documents">
            <div class="d-flex align-items-center mb-4">
              <i class="ki-outline ki-folder text-info fs-2 me-3"></i>
              <h4 class="subsection-title mb-0">Order Contents</h4>
              <span class="badge badge-light-info ms-3 fs-7">
                {{ getDocumentCount(selectedTransaction.order.orderable?.knowledge_documents) }}
                {{ getDocumentCount(selectedTransaction.order.orderable?.knowledge_documents) === 1 ? 'Document' : 'Documents' }}
              </span>
            </div>
            <div class="documents-container">
              <div *ngFor="let docGroup of selectedTransaction.order.orderable.knowledge_documents" class="document-group mb-3">
                <div class="document-card p-4 mb-3" *ngFor="let doc of docGroup">
                  <div class="d-flex align-items-center">
                    <div class="file-icon-wrapper me-4">
                      <img [src]="getFileIcon(doc.file_extension)"
                           [alt]="doc.file_extension + ' file'"
                           class="file-extension-icon"
                           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
                           style="width: 48px; height: 48px; object-fit: contain;">
                 
                    </div>
                    <div class="document-details flex-grow-1">
                      <div class="document-name text-gray-900 fw-bold fs-6 mb-1">
                        {{ doc.file_name }}
                      </div>
                      <div class="document-meta d-flex align-items-center">
                        <span class="badge badge-light-info me-3 px-2 py-1 fs-8 fw-semibold">{{ doc.file_extension.toUpperCase() }}</span>
                        <span class="text-muted fs-8 d-flex align-items-center">
                          <i class="ki-outline ki-document fs-7 me-2"></i>
                          Document File
                        </span>
                      </div>
                    </div>
                    <div class="document-price ms-auto">
                      <div class="price-display d-flex align-items-center">
                        <span class="text-success fw-bold fs-5">${{ doc.price }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Meeting Booking -->
          <div class="meeting-section" *ngIf="selectedTransaction.order.orderable.meeting_booking">
            <h4 class="subsection-title">Meeting Details</h4>
            <div class="meeting-card">
              <div class="meeting-grid">
                <div class="meeting-item">
                  <i class="pi pi-calendar meeting-icon"></i>
                  <div class="meeting-content">
                    <span class="meeting-label">Date</span>
                    <span class="meeting-value">{{ selectedTransaction.order.orderable.meeting_booking.date }}</span>
                  </div>
                </div>
                <div class="meeting-item">
                  <i class="pi pi-clock meeting-icon"></i>
                  <div class="meeting-content">
                    <span class="meeting-label">Time</span>
                    <span class="meeting-value">{{ selectedTransaction.order.orderable.meeting_booking.start_time }} - {{ selectedTransaction.order.orderable.meeting_booking.end_time }}</span>
                  </div>
                </div>
                <div class="meeting-item">
                  <i class="pi pi-info-circle meeting-icon"></i>
                  <div class="meeting-content">
                    <span class="meeting-label">Status</span>
                    <span class="badge" [ngClass]="getMeetingStatusClass(selectedTransaction.order.orderable.meeting_booking.status)">
                      {{ selectedTransaction.order.orderable.meeting_booking.status | titlecase }}
                    </span>
                  </div>
                </div>
              </div>
              <div class="meeting-details">
                <h5 class="meeting-title">{{ selectedTransaction.order.orderable.meeting_booking.title }}</h5>
                <p class="meeting-description">{{ selectedTransaction.order.orderable.meeting_booking.description }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button pButton type="button" label="Close" icon="pi pi-times" class="p-button-secondary" (click)="displayDialog = false"></button>
    </div>
  </ng-template>
</p-dialog>